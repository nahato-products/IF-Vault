---
date: 2026-02-26
author: sekiguchi
tags: [if-db, migration, 設計]
---

# データ移行戦略

## 基本方針

**一括移行はしない。都度インポート方式を採用する。**

旧スプレッドシートのインフルエンサーマスタは以下の理由で一括移行が困難：

- 同一人物が複数レコードとして登録されている（重複多数）
- SNS URL・口座情報が空・不正確なレコードが多い
- 請求先・所属事務所の変更履歴が混在している

→ **都度インポート + 担当者確認フロー**で段階的にデータを整備する。

---

## インフルエンサーマスタのインポートフロー

```
スプシ（旧データ） → 重複チェック → status=仮登録でDB挿入 → 担当者確認 → 本登録
```

### Step 1: 重複チェック（インポート前）

以下の条件で既存レコードと照合し、重複候補を洗い出す。

```sql
-- SNS URLで重複チェック
SELECT
    i.influencer_id,
    i.influencer_name,
    sa.account_url,
    sa.platform_id
FROM t_influencers i
JOIN t_influencer_sns_accounts sa ON i.influencer_id = sa.influencer_id
WHERE sa.account_url = :import_account_url
  AND sa.platform_id = :import_platform_id;

-- 名前の部分一致チェック
SELECT influencer_id, influencer_name
FROM t_influencers
WHERE influencer_name LIKE '%' || :import_name || '%'
   OR influencer_alias LIKE '%' || :import_name || '%';

-- login_id の重複チェック（NOT NULL UNIQUEのため必須）
SELECT influencer_id, influencer_name, login_id
FROM t_influencers
WHERE login_id = :import_login_id;
-- ヒットした場合はスプシの login_id を確認・別途採番が必要
```

重複候補が見つかった場合 → 担当者に確認依頼してからインポート。

### Step 2: 仮登録でINSERT

確認前のデータは `status_id = 2`（仮登録）で挿入。請求処理・集計対象から自動的に除外される。

```sql
-- インフルエンサー本体
INSERT INTO t_influencers (influencer_name, influencer_alias, login_id, status_id, compliance_check, created_by, updated_by)
VALUES (:name, :alias, :login_id, 2, false, :agent_id, :agent_id);

-- 自動で1人グループを作成（アプリ側トランザクション）
-- Step1: t_influencer_groups INSERT
-- Step2: t_group_members INSERT
-- ※ group_id 未設定のインフルエンサーは集計から漏れるため必須
```

### Step 3: 担当者確認 → 本登録

担当エージェントが画面上で内容を確認・修正し、`status_id = 1`（本登録）に更新。

```sql
UPDATE t_influencers
SET status_id = 1, updated_by = :agent_id
WHERE influencer_id = :id;
```

---

## フェーズ別移行計画

## 事前準備（移行開始前に必須）

- [ ] 全担当エージェントを `t_agents` に登録済みであること（`created_by` / `updated_by` に使用するため）
- [ ] `t_sns_platforms` のシードデータ適用済みであること（007_seed_data.sql）
- [ ] `t_categories` のシードデータ適用済みであること（007_seed_data.sql）
- [ ] システム管理者アカウント（`agent_id = 1`）が存在すること

### Phase 1: 新規登録分（即日対応）

- 新しいインフルエンサーは全てシステムから登録
- 旧スプシへの新規追加を禁止

### Phase 2: アクティブなインフルエンサー（優先移行）

- 直近3ヶ月以内にCVが発生しているパートナーに紐づくインフルエンサーを優先
- 担当エージェントが週次でインポート・確認

### Phase 3: 休眠インフルエンサー（随時）

- CVが発生した時点でシステムに取り込む
- 移行完了まで旧スプシと併用

---

## 重複レコードのクレンジング方針

旧スプシの重複レコードは以下の判断基準で処理：

| ケース | 対応 |
|--------|------|
| 完全同一人物（SNS・口座一致） | 新システムでは1レコードに統合 |
| 請求先が変わった（個人→事務所） | グループを別に作成して管理 |
| SNSが変わった（旧アカウント削除） | SNSアカウントの `status_id = 9` で無効化 |
| グループYouTuber（YouTube共有・Instagram個別） | 各自を個人レコードで登録し、グループ（`t_influencer_groups`）で束ねる |

---

## CVデータ（t_daily_performance_details）の移行

CVデータは一括移行**する**。ただしパートナーの `group_id` が未設定の場合は集計から漏れるため、以下の手順で行う。

```sql
-- 移行前チェック: group_id 未設定パートナー数
SELECT COUNT(*) FROM t_partners WHERE group_id IS NULL;
-- → 0件になってから移行実行

-- 旧スプシCSVからの取り込み（Cloud Run バッチ）
-- group_id は partner_id → t_partners.group_id から自動セット
```

### 排他制御

CVデータ移行バッチの実行中は、`t_partners` への新規書き込みをアプリ側で一時停止すること。
移行バッチ開始直前に再度 group_id IS NULL チェックを実行する。

```sql
-- バッチ開始直前に再チェック
SELECT COUNT(*) FROM t_partners WHERE group_id IS NULL;
-- → 0件であることを確認してからバッチ実行
```

---

## 移行完了判定基準

- [ ] 全アクティブインフルエンサーの `status_id = 1` 本登録完了
- [ ] `t_partners.group_id` が全件 NOT NULL
- [ ] CVデータの集計値が旧スプシと一致（±1%以内）
- [ ] 担当エージェント全員がシステムにログイン済み
- [ ] 旧スプシへの新規書き込みが0件（1週間監視）
