---
created: 2026-02-25
tags: [if-db, ユースケース, 設計, 要件定義]
status: 議論中
---

# IF-DB ユースケース一覧

## 📌 ユーザー種別

| 種別 | 説明 |
|------|------|
| **エージェント** | 社内担当営業。インフルエンサーを管理・集計する |
| **インフルエンサー** | 登録者本人。自分のデータを参照・更新する |
| **経理担当者** | 請求・支払処理を行う |
| **管理者** | システム全体を管理する |
| **システム（バッチ）** | 自動処理。人間ではなくプログラムが主体 |

> [!NOTE]
> **クライアント（広告主）はこのシステムを使わない。**
> **外部アプリとの連携はCSV取り込み機能（UC-M12）で対応する。**

---

## 👤 エージェント

### マスタ管理

| ID | ユースケース | 対応テーブル | 設計対応状況 |
|----|------------|------------|------------|
| UC-A1 | インフルエンサー新規登録（グループ自動生成含む） | `t_influencers` / `t_influencer_groups` / `t_group_members` | ✅ グループID自動生成は設計思想に明記済み |
| UC-A2 | インフルエンサー情報編集 | `t_influencers` | ✅ |
| UC-A3 | グループ新規作成 | `t_influencer_groups` | ✅ |
| UC-A4 | グループにメンバー追加 | `t_group_members` | ✅ |
| UC-A5 | グループからメンバー除外（end_at 更新） | `t_group_members` | ✅ |
| UC-A6 | コラボグループ作成（end_at に終了予定日を設定） | `t_influencer_groups` | ✅ |
| UC-A7 | インフルエンサー重複検知・一覧表示 | `t_influencers` / `t_sns_accounts` | ⚠️ 検知ロジック未定義 |
| UC-A8 | 重複インフルエンサーの手動統合（削除） | `t_influencers` | ✅ 手動削除に方針確定 |
| UC-A9 | 担当エージェント変更・履歴管理 | `t_influencer_agent_assignments` | ✅ |
| UC-A10 | 単価設定（適用期間・上限管理） | `t_unit_prices` | ✅ |
| UC-A11 | キャンペーン設定（媒体・報酬体系・価格区分） | `t_campaigns` | ✅ |
| UC-A12 | 広告コンテンツ登録・編集 | `t_ad_contents` | ✅ |
| UC-A13 | **セミアフィステータス切り替え** | 未定義 | 🔴 未対応 |
| UC-A14 | パートナーサイト登録・編集 | `t_partner_sites` | ✅ |

### 参照・検索・集計

| ID | ユースケース | 対応テーブル | 設計対応状況 |
|----|------------|------------|------------|
| UC-A15 | 担当インフルエンサー一覧表示 | `t_influencer_agent_assignments` / `t_influencers` | ✅ |
| UC-A16 | インフルエンサー詳細表示（SNS・グループ・成果） | 複数 | ✅ |
| UC-A17 | エージェント単位での成果集計 | `t_daily_performance_details` / `t_agents` | ✅ クエリパターン定義済み |
| UC-A18 | 担当者・BU・案件区分での検索・絞り込み | `t_influencers` / `t_partner_sites` | ⚠️ BU・案件区分の項目未定義 |
| UC-A19 | クライアント別の投資対効果確認 | `t_daily_performance_details` / `t_clients` | ✅ クエリパターン定義済み |
| UC-A20 | グループ単位の成果確認 | `t_influencer_groups` / `t_partners` | ✅ |
| UC-A21 | コラボグループの成果を個別確認 | `t_influencer_groups` | ✅ |
| UC-A22 | 0A〜0F分類別の成果確認 | `t_daily_performance_details` | ⚠️ 0A〜0F分類の属性未定義 |

---

## 🎤 インフルエンサー

| ID | ユースケース | 対応テーブル | 設計対応状況 |
|----|------------|------------|------------|
| UC-I1 | ログイン | `t_influencer_security` | ✅ |
| UC-I2 | 自分のグループ情報確認 | `t_group_members` / `t_influencer_groups` | ✅ |
| UC-I3 | 所属グループ切り替え（複数グループの場合） | `t_group_members` | ✅ |
| UC-I4 | 自分のSNSアカウント登録・更新 | `t_sns_accounts` | ✅ |
| UC-I5 | グループの住所登録・更新 | `t_group_addresses` | ✅ |
| UC-I6 | グループの口座情報登録・更新 | `t_group_bank_accounts` | ✅ |
| UC-I7 | 自分の成果データ確認（月次・案件別） | `t_daily_performance_details` | ✅ |
| UC-I8 | キャンペーン情報確認 | `t_campaigns` | ✅ |

---

## 💴 経理担当者

| ID | ユースケース | 対応テーブル | 設計対応状況 |
|----|------------|------------|------------|
| UC-E1 | グループ単位の請求情報確認 | `t_influencer_groups` / `t_group_bank_accounts` | ✅ |
| UC-E2 | 請求処理実行（口座バリデーション含む） | `t_group_bank_accounts` | ✅ バリデーション設計思想に明記済み |
| UC-E3 | グロス/ネット計算結果確認 | `t_daily_performance_details` / `t_campaigns` | ✅ price_type で対応 |
| UC-E4 | 報酬体系別（固定・予算・成果）の集計確認 | `t_campaigns` / `t_unit_prices` | ✅ 超過処理はバックエンドで処理 |
| UC-E5 | 予算超過チェック | `t_unit_prices.limit_cap` | ✅ バックエンドで処理。limit_cap を参照するのみ |
| UC-E6 | **セミアフィ処理結果確認** | 未定義 | 🔴 未対応 |
| UC-E7 | CSV出力（エージェント請求・インフルエンサー支払） | なし | 🔴 未対応 |
| UC-E8 | 月次の成果データ締め処理（承認） | `t_daily_performance_details.status_id` | ✅ status_id=2 で承認 |

---

## 🔧 管理者

| ID | ユースケース | 対応テーブル | 設計対応状況 |
|----|------------|------------|------------|
| UC-M1 | エージェント追加・編集・無効化 | `t_agents` | ✅ |
| UC-M2 | 部署管理（階層構造） | `t_departments` | ✅ |
| UC-M3 | クライアント登録・編集 | `t_clients` | ✅ |
| UC-M4 | 重複インフルエンサーのクレンジング | `t_influencers` | ✅ 手動削除 |
| UC-M5 | グループ管理（編集・無効化） | `t_influencer_groups` | ✅ |
| UC-M6 | データ整合性確認（0件検知等） | `t_daily_performance_details` | ✅ Slack通知で対応 |
| UC-M7 | **0A〜0F分類ルールの設定・変更** | 未定義 | 🔴 未対応 |
| UC-M8 | BU・案件区分マスタ管理 | 未定義 | 🔴 未対応 |

---

## ⚙️ システム（バッチ）

| ID | ユースケース | 対応テーブル | 設計対応状況 |
|----|------------|------------|------------|
| UC-S1 | BQから前日のCV・クリックデータ取得（毎朝8時） | `t_daily_performance_details` / `t_daily_click_details` | ✅ BQ設計書あり |
| UC-S2 | 0A〜0F分類処理（調理） | Cloud Run で処理 | ✅ BQ設計書あり |
| UC-S3 | Cloud SQLへのupsert | 全集計テーブル | ✅ |
| UC-S4 | 0件検知・Slack通知 | なし（監視ロジック） | ✅ |
| UC-S5 | セミアフィの自動計算（将来フェーズ） | 未定義 | 🔴 将来対応 |

---

## 👤 エージェント（追加）

### 認証・セキュリティ

| ID | ユースケース | 対応テーブル | 設計対応状況 |
|----|------------|------------|------------|
| UC-A23 | エージェントログイン | `t_agent_security` | ✅ |
| UC-A24 | ログイン失敗・アカウントロック | `t_agent_security.login_failure_count` | ✅ |
| UC-A25 | パスワードリセット | `t_agent_security` | ✅ |
| UC-A26 | ログアウト | `t_agent_security.last_login_at` | ✅ |

### コンプライアンス・ステータス管理

| ID | ユースケース | 対応テーブル | 設計対応状況 |
|----|------------|------------|------------|
| UC-A27 | インフルエンサーのコンプライアンスチェック更新 | `t_influencers.compliance_check` | ✅ |
| UC-A28 | 仮登録→本登録へのステータス変更 | `t_influencers.status_id` | ✅ |
| UC-A29 | インフルエンサーの無効化（退会・停止） | `t_influencers.status_id = 9` | ✅ |
| UC-A30 | 適格請求書番号（インボイス）の登録・確認 | `t_influencer_groups.invoice_tax_id` | ✅ |

### 単価・報酬体系管理

| ID | ユースケース | 対応テーブル | 設計対応状況 |
|----|------------|------------|------------|
| UC-A31 | 単価変更履歴の確認（期間別） | `t_unit_prices` | ✅ start_at/end_at で管理 |
| UC-A32 | グロス/ネット単価の切り替え確認 | `t_campaigns.price_type` | ✅ |
| UC-A33 | 固定・予算・成果の報酬体系設定 | `t_campaigns.reward_type` | ✅ |
| UC-A34 | 予算超過時の処理パターン設定 | `t_unit_prices.limit_cap` | ✅ バックエンドで処理 |
| UC-A35 | セミアフィの月別切り替え設定 | `t_unit_prices.semi_unit_price` | ✅ バックエンドで処理 |

### 広告・案件管理

| ID | ユースケース | 対応テーブル | 設計対応状況 |
|----|------------|------------|------------|
| UC-A36 | 広告グループ（案件）の作成・編集 | `t_ad_groups` | ✅ |
| UC-A37 | 案件へのクライアント紐付け | `t_ad_contents` | ✅ |
| UC-A38 | 案件へのインフルエンサー（コンテンツ）アサイン | `t_ad_contents.person_id` | ✅ person_idはFK不要に確定（固定運用） |
| UC-A39 | 広告コンテンツの配信ステータス変更 | `t_ad_contents.delivery_status` | ✅ |
| UC-A40 | コラボグループ終了処理（end_at 更新） | `t_influencer_groups` | ✅ |

### パートナー管理

| ID | ユースケース | 対応テーブル | 設計対応状況 |
|----|------------|------------|------------|
| UC-A41 | パートナー新規登録 | `t_partners` | ✅ |
| UC-A42 | パートナーとグループの紐付け | `t_partners.group_id` | ✅ |
| UC-A43 | パートナーの有効化・無効化 | `t_partners.status_id` | ✅ |
| UC-A44 | 新規メディア（パートナーサイト）追加検知・登録 | `t_partner_sites` | ⚠️ 検知ロジック未定義 |
| UC-A45 | IF卸/トータルマーケット区分の設定 | 未定義 | 🔴 未対応 |

### データ出力・レポート

| ID | ユースケース | 対応テーブル | 設計対応状況 |
|----|------------|------------|------------|
| UC-A46 | 月次成果レポート出力 | `t_daily_performance_details` | ✅ クエリ定義済み |
| UC-A47 | 案件別成果レポート出力 | `t_daily_performance_details` / `t_ad_contents` | ✅ |
| UC-A48 | 0A〜0F分類別レポート出力 | 未定義 | 🔴 未対応 |

---

## 🎤 インフルエンサー（追加）

| ID | ユースケース | 対応テーブル | 設計対応状況 |
|----|------------|------------|------------|
| UC-I9 | 初回ログイン・仮登録から本登録への移行 | `t_influencer_security` / `t_influencers.status_id` | ✅ |
| UC-I10 | パスワードリセット | `t_influencer_security` | ✅ |
| UC-I11 | ログアウト | `t_influencer_security.last_login_at` | ✅ |
| UC-I12 | 自分のコンプライアンス情報確認 | `t_influencers.compliance_check` | ✅ |
| UC-I13 | 自分の適格請求書番号（インボイス）登録・確認 | `t_influencer_groups.invoice_tax_id` | ✅ |
| UC-I14 | 自分の請求書区分の確認 | `t_influencer_groups.billing_type_id` | ✅ |
| UC-I15 | 過去の成果データの期間指定検索 | `t_daily_performance_details` | ✅ |

---

## 💴 経理担当者（追加）

| ID | ユースケース | 対応テーブル | 設計対応状況 |
|----|------------|------------|------------|
| UC-E9 | 未承認データ一覧の確認 | `t_daily_performance_details.status_id = 1` | ✅ |
| UC-E10 | CV成果データの承認処理 | `t_daily_performance_details.status_id = 2` | ✅ |
| UC-E11 | CV成果データの否認処理（理由記録） | `t_daily_performance_details.status_id = 9` | ⚠️ 否認理由カラム未定義 |
| UC-E12 | 月次締め処理（全承認の確認） | `t_daily_performance_details` | ⚠️ 締め処理フロー未定義 |
| UC-E13 | 支払い明細の確認（インフルエンサー支払） | 未定義 | 🔴 スコープ外（後フェーズ） |
| UC-E14 | 請求書出力（PDF等） | 未定義 | 🔴 未対応 |

---

## 🔧 管理者（追加）

| ID | ユースケース | 対応テーブル | 設計対応状況 |
|----|------------|------------|------------|
| UC-M9 | エージェントのパスワードリセット | `t_agent_security` | ✅ |
| UC-M10 | エージェント操作ログの確認 | `t_agent_logs` | ✅ |
| UC-M11 | インフルエンサー変更ログの確認 | `t_influencer_logs` | ✅ |
| UC-M12 | インフルエンサーの一括インポート（CSV）※他アプリからのデータ取り込み含む | `t_influencers` | 🔴 未対応 |
| UC-M13 | 単価の一括更新（CSV） | `t_unit_prices` | 🔴 未対応 |
| UC-M14 | 0A〜0F分類ルールの設定・変更 | 未定義 | 🔴 未対応 |
| UC-M15 | BU・案件区分マスタ管理 | 未定義 | 🔴 未対応 |
| UC-M16 | SNSアカウントURL重複リスト出力 | `t_sns_accounts` | ⚠️ 重複検知ロジック未定義 |
| UC-M17 | 口座情報重複リスト出力 | `t_group_bank_accounts` | ✅ |
| UC-M18 | コラボグループの終了期限一覧確認 | `t_influencer_groups` | ✅ |

---

## ⚙️ システム（バッチ）（追加）

| ID | ユースケース | 対応テーブル | 設計対応状況 |
|----|------------|------------|------------|
| UC-S6 | 口座未登録グループの担当者通知 | `t_group_bank_accounts` / Slack | ✅ DB設計済み。Slack通知はバッチ実装時 |
| UC-S7 | コラボグループ終了期限アラート通知 | `t_influencer_groups.end_at` | ✅ DB設計済み。Slack通知はバッチ実装時 |
| UC-S8 | 新規パートナーサイト自動検知・Slack通知 | `t_partner_sites` | ⚠️ 検知ロジック未定義 |
| UC-S9 | セミアフィ月別自動切り替え（将来フェーズ） | 未定義 | 🔴 将来対応 |

---

## 📊 設計対応状況サマリー

| ステータス | 件数 | 内容 |
|-----------|------|------|
| ✅ 対応済み | 60件 | ER図・設計書に反映済み |
| ⏳ テーブル追加待ち | 0件 | グループ概念のER図反映で解決済み |
| ⚠️ 定義不足 | 8件 | 要追加設計 |
| 🔴 未対応 | 12件 | 設計に含まれていない・将来フェーズ |
| **合計** | **80件** | |

---

## 🔴 未対応の重要ユースケース（要設計）

### 1. セミアフィステータス切り替え（UC-A13 / UC-E6）

**現状**: 毎日手動で切り替え。アプリ化で自動化したい。

**必要な設計**:
```
t_semi_affi_settings? または t_campaigns に追加？
  - is_semi_affi BOOLEAN
  - semi_switch_date DATE  ← 月別切り替え日
  - semi_unit_price DECIMAL（t_unit_prices に semi_unit_price は既にある）
```

> [!WARNING]
> `t_unit_prices.semi_unit_price` は既にあるが、**切り替えのトリガー・ルール**が未定義。

---

### 2. CSV出力（UC-E7）

**現状**: スプレッドシートで手動出力。アプリ化で自動化。

**必要な設計**:
- 出力フォーマット仕様の定義
- パートナーID重複・コロン区切り問題への対応（変更点ログ参照）

---

### 3. 0A〜0F分類ルール管理（UC-M7）

**現状**: コードに埋め込み or 手動。

**必要な設計**:
- 分類ルールをDBで管理するか、Cloud Run のコードで管理するか決定が必要

---

### 4. BU・案件区分マスタ（UC-M8 / UC-A18）

**現状**: パートナーサイト名に埋め込み（例: `[インスタ]田中花子_案件A_BU_担当者名`）

**必要な設計**:
```
t_partner_sites にカスタム項目追加？
  - bu_type    SMALLINT  "BU区分"
  - case_type  SMALLINT  "案件区分（0A〜0F等）"
```

---

## ⚠️ 定義不足の項目（要追加設計）

### 予算超過時の処理パターン（UC-E5）

報酬体系の「予算」パターンで、予算額超過時の処理が案件ごとに異なる。

```
パターンA: 超過分も支払う
パターンB: 超過分は支払わない（上限でキャップ）
```

`t_unit_prices.limit_cap` はあるが、超過時の処理パターンを表すカラムが未定義。

---

## 📅 MVP スコープ

> 当初から変更になったもの.md より

```
✅ スコープIN:
  - 株式会社ナハトのパートナー（固定）
  - 個人管理画面の成果パートナー
  - IF卸

❌ スコープOUT（後フェーズ）:
  - トータルマーケット案件
  - インフルエンサー単価
  - セミアフィ自動化（UC-S5）
```

---

作成日: 2026-02-25
作成者: sekiguchi
