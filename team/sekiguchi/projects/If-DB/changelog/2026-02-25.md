---
date: 2026-02-25
sprint: 設計フェーズ
author: sekiguchi
tags: [if-db, changelog, 設計, db]
---

# 変更ログ 2026-02-25

## 📌 概要

インフルエンサーマスタにグループ概念を導入するための設計議論。
ER図・設計思想を大幅アップデート。

---

## 🔄 変更内容

### 1. 監査カラムの標準化
**対象ファイル**: `インフルエンサー管理システムER図.md`

全マスタテーブルに以下4カラムを追加。
- `created_by` / `updated_by` / `created_at` / `updated_at`

対象外テーブル（ログ系・セキュリティ系・集計系）の方針も明文化。

---

### 2. カラム命名規則の統一
**対象ファイル**: `インフルエンサー管理システムER図.md`

| 変更前 | 変更後 |
|--------|--------|
| `assigned_at` / `unassigned_at` | `start_at` / `end_at` |
| `delivery_start_at` / `delivery_end_at` | `start_at` / `end_at` |

- 恒常グループの `end_at` は `2999-12-31`（センチネル値）
- 論理削除は `status_id = 9` で統一

---

### 3. 設計思想セクション追加
**対象ファイル**: `インフルエンサー管理システムER図.md`

以下のセクションを新規追加。

- **カラム命名規則**: `start_at`/`end_at` 統一・センチネル値・配信中判定ルール
- **プログレッシブ登録**: Apple的UX・Skip可能・後から補完
- **グループID自動生成**: アプリ側の責任・トランザクション必須
- **請求処理時のバリデーション**: 口座未登録時のハンドリング方針

---

### 4. コメント追加
**対象ファイル**: `インフルエンサー管理システムER図.md`

| テーブル | カラム | 追加コメント |
|---------|--------|------------|
| `t_ad_contents` | `start_at` / `end_at` | "配信開始日" / "配信終了日" |
| `t_unit_prices` | `start_at` / `end_at` | "適用開始日" / "適用終了日" |

---

## 🏗️ 設計議論メモ（決定事項）

### グループ概念の導入方針
- **2レイヤー構造**: メンバー（人間）とグループ（活動単位）
- **中間テーブル（案C）採用**: `t_group_members` で多対多を管理
- **コラボ対応**: `is_temporary` フラグではなく `end_at` で管理（`2999-12-31` = 恒常）
- **1人グループ強制**: 全インフルエンサーに最低1グループを付与

### グループに移動する情報
| 移動元 | 移動先 | カラム |
|--------|--------|--------|
| `t_influencers` | `t_influencer_groups`（仮） | `billing_type_id` / `invoice_tax_id` / `affiliation_name` / `affiliation_type_id` |
| `t_influencers` | `t_group_bank_accounts` | `account_number` |
| `t_addresses` | `t_group_addresses` | 住所情報全体 |

### インフルエンサー個人に残す情報
- `account_number`（口座）→ **グループに移動**（訂正: 個人ではなくグループ単位）
- `t_sns_accounts`（SNS）→ **個人紐づき維持**（グループ経由で引ける）

### プログレッシブ登録の思想
- Nullable = バグではなく意図的なUX判断
- 移行期は「グループ側を正」とし、旧カラムは `@deprecated`

---

---

### 5. ユースケース一覧の新規作成
**対象ファイル**: `ユースケース一覧.md`（新規）

全ユーザー種別・業務フローから網羅的に洗い出し。**80件**のユースケースを定義。

| 種別 | 件数 |
|------|------|
| エージェント（マスタ管理・参照・集計・認証・コンプラ・単価・広告・パートナー・出力） | 48件 |
| インフルエンサー | 15件 |
| 経理担当者 | 14件 |
| 管理者 | 18件 |
| システム（バッチ） | 9件 |

各UCに対応テーブルと設計対応状況（✅/⏳/⚠️/🔴）を明記。

---

### 6. スコープ方針の確定
**対象ファイル**: `ユースケース一覧.md`

| 方針 | 内容 |
|------|------|
| クライアント（広告主）はシステムを使わない | UIなし。エージェントが参照専用で管理 |
| 外部アプリとの連携 | CSV取り込み機能（UC-M12）で対応 |

---

## ⏳ 次フェーズ（未着手）

- [x] グループ概念をER図に反映（新設4テーブル）→ 2026-02-25完了
  - `t_influencer_groups`
  - `t_group_members`（中間テーブル）
  - `t_group_addresses`
  - `t_group_bank_accounts`
- [x] `t_partners` に `group_id` FK 追加 → 2026-02-25完了
- [x] `t_influencers` から移行カラムを削除（`billing_type_id` / `invoice_tax_id` / `affiliation_name` / `affiliation_type_id` / `account_number`）→ 2026-02-25完了
- [x] テーブル名「`t_influencer_groups`」の命名確定 → `t_influencer_groups` 確定。表示名はビュー側で制御（2026-02-26決定）
- [x] `@deprecated` カラムの削除方針を設計思想セクションに追記 → 2026-02-26完了
- [x] ER図「設計の特徴」「総合評価」のグループ概念を「次フェーズ」→「導入済み」に更新 → 2026-02-26完了
- [x] `t_partners.influencer_id`（@deprecated）をER図から削除 → 2026-02-26完了
- [x] `t_ad_contents.client_id` に FK制約追加 → 2026-02-26完了
- [x] `t_daily_performance_details` をサロゲートキー（`id PK`）に変更・複合PK解消 → 2026-02-26完了
- [x] クエリパターンを group_id 経由に更新 → 2026-02-26完了
- [x] ユースケース一覧の設計対応状況を一括更新（⏳18件→✅、UC-A38の⚠️→✅）→ 2026-02-26完了
- [x] 単価計算ロジックはバックエンド処理に確定。ER図設計思想に追記。UC-E4・E5・A34・A35を✅に更新 → 2026-02-26完了
- [x] DBレビュー対応（全6件） → 2026-02-26完了
  - 口座情報の暗号化方針を設計思想に追記
  - インデックス戦略をDB制約ルールセクションに追記
  - `t_daily_click_details` サロゲートキー（id PK）化・UNIQUE制約追加
  - `t_influencer_groups` / `t_group_members` の `start_at` / `end_at` を DATE 型に統一
  - `t_ad_contents.person_id` コメントにFK不要の理由を追記
  - `t_partners.group_id` NULLガードをバリデーションセクションに追記
- [x] 100点対応（4件） → 2026-02-26完了
  - `t_daily_performance_details` の `site_id` / `content_id` に FK追加
  - `t_daily_performance_details` に `rejection_reason TEXT` カラム追加（否認理由）
  - `t_ad_contents.delivery_status` に値定義コメント追加
  - `t_campaigns` に `UNIQUE (site_id, platform_type, reward_type, price_type)` 追加
- [x] SNSアカウント設計を1:N構成に刷新 → 2026-02-26完了
- [x] 楽観ロック導入（t_unit_prices / t_campaigns に version カラム追加・設計思想追記） → 2026-02-26完了
- [x] 再整合性チェック対応 → 2026-02-26完了
- [x] t_daily_performance_details に group_id スナップショットカラム追加（グループ単位RLS対応） → 2026-02-26完了
- [x] DDL v6.0.0 作成（ER図最新版ベースで全面書き直し） → 2026-02-26完了
  - `team/sekiguchi/projects/If-DB/sql/001_create_tables.sql`（25テーブル + パーティション子テーブル6個）
  - `team/sekiguchi/projects/If-DB/sql/002_create_indexes.sql`（RLS用インデックス含む）
  - `team/sekiguchi/projects/If-DB/sql/006_create_rls.sql`（5ロール × 5テーブル、Cloud SQL対応）
  - `team/sekiguchi/projects/If-DB/sql/007_seed_data.sql`（t_sns_platforms 7件 / t_categories 27件）
- [x] マイグレーション戦略 作成（都度インポート方式・重複クレンジング方針） → 2026-02-26完了
  - `team/sekiguchi/projects/If-DB/マイグレーション戦略.md`
  - `t_daily_performance_details.content_id` → `ad_content_id` にリネーム（テーブル定義・DB制約・クエリパターン全箇所）
  - `t_ad_groups` に `status_id SMALLINT` 追加
  - 設計思想: `t_ad_contents.delivery_status` が論理削除兼用である旨を明記
- [x] 整合性チェック対応（全8件） → 2026-02-26完了
  - `t_daily_click_details.site_id` に FK 注釈追加
  - `t_categories` 自己参照リレーション追加（`t_categories ||--o{ t_categories : "階層構造"`）
  - DB制約: `t_sns_platforms.platform_key` に UNIQUE追加
  - DB制約: `t_influencer_sns_accounts` に `UNIQUE (influencer_id, platform_id) WHERE is_primary = true` 追加
  - DB制約: `t_account_categories` に `UNIQUE (account_id) WHERE is_primary = true` 追加
  - 設計思想: サロゲートキー命名方針セクションを追記
  - `t_sns_accounts`（固定カラム1:1）を削除
  - `t_sns_platforms`（プラットフォームマスタ）新設
  - `t_influencer_sns_accounts`（1:N・platform_id FK）新設
  - `t_categories`（カテゴリマスタ・階層対応）新設
  - `t_account_categories`（SNSアカウント↔カテゴリ中間テーブル）新設
  - DB制約: `UNIQUE (account_id, category_id)` 追加
  - インデックス: `(influencer_id, status_id)` / `(platform_id)` 追加
