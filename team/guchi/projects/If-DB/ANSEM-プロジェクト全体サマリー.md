---
created: 2026-02-13
tags: [ansem, if-db, summary, notebooklm]
author: guchi
version: v5.4.0
---

# ANSEM プロジェクト全体サマリー

nahato Inc. のインフルエンサーマーケティング管理を、スプレッドシートからデータベースへ移行するプロジェクト。管理部とIFチームが日々使うインフルエンサー情報・成果データ・請求業務をシステム化する。

## プロジェクトの背景と課題

管理部では数百名のインフルエンサー情報をGoogleスプレッドシートで管理してきた。データが複数のシートに分散し、名前の表記揺れや重複が常態化している。月別シートには45個以上の関数が入り組み、「調理」と呼ばれる0A〜0Fシートの加工工程を経て請求データを作っている。担当者が変わると引き継ぎ困難で、単価管理も混乱が起きやすい状態だった。

この状況を根本から解決するため、PostgreSQLベースの管理システム ANSEM を新規構築する。

## ANSEMという名前

当初は AFAD という仮称だったが、プロジェクトの方向性が固まった段階でANSEMに改名した。インフルエンサーマスターと成果管理を統合するシステムという位置づけ。

## 現在のステータス

DB設計は v5.4.0 まで完成している。設計レビューも全23件の指摘に対応済みで、品質スコアは9.2/10まで上がった。SQLファイルも全5本が書き上がっており、テーブル作成・インデックス・コメント・トリガー・パーティションまで実行可能な状態にある。次はPhase 1の実装に入る段階。

## データベースの全体像

32テーブルで構成される。マスタ系15、トランザクション系16、システム系1。

### 組織とエージェント

社員をエージェントと呼ぶ。m_agentsにエージェント情報、m_agent_securityに認証情報を分離して格納する。部署はm_departmentsで階層構造をもつ。エージェントの役割はm_agent_role_typesで定義し、メイン担当・サブ担当・スカウトなどを区別できる。

### インフルエンサー

m_influencersがシステムの中心エンティティ。ここからSNSアカウント、住所、銀行口座、請求先、担当者割当が枝分かれする。

SNSアカウントはt_influencer_sns_accountsで複数登録に対応している。Instagram、YouTube、Twitter、TikTokなどプラットフォームごとにレコードをもち、m_sns_platformsでプラットフォーム定義を管理する。さらにt_account_categoriesでSNSアカウントとカテゴリの多対多紐付けを実現している。

住所はt_addressesで国内・海外の両方に対応。銀行口座もt_bank_accountsで通貨別に管理できる。請求先はt_billing_infoでインボイス制度の適格請求書番号にも対応した。

担当者の割当はt_influencer_agent_assignmentsで履歴管理している。assigned_atとunassigned_atで期間を持ち、is_activeフラグで現在の有効性を判定する。

### パートナーとサイト

パートナーはASPや配信媒体を指す。m_partnersで管理し、その傘下のサイトや媒体をt_partner_sitesで紐付ける。パートナー区分はm_partners_divisionで「IF卸」と「トータルマーケット」を区別する。IF経営を兼ねるパートナーも存在するため、m_partnersからm_influencersへの任意参照を設けている。

### 広告とキャンペーン

クライアント（広告主）はm_clientsで管理。広告グループ（案件単位）はm_ad_groups、広告コンテンツ（クリエイティブ）はm_ad_contentsに格納する。キャンペーン設定はm_campaignsで、これは加工用のパラメータテーブルとして機能する。

単価設定はt_unit_pricesで期間管理している。start_atとend_atで有効期間を持ち、楽観ロックで同時編集を防止する。

### 日次集計

t_daily_performance_detailsでCV（コンバージョン）、t_daily_click_detailsでクリックを日次集計する。どちらもスナップショット方式で、集計時点のパートナー名・サイト名・クライアント名・コンテンツ名を保存する。マスタが後から変更されても集計データの整合性が崩れない。

年次パーティションで分割しており、2024年・2025年・2026年のパーティションが準備済み。次元カラムはNOT NULLかつFK制約付き、集計値はNOT NULL DEFAULT 0というルールを徹底している。

### 請求確定

t_billing_runsで請求確定バッチを管理する。期間選択とフィルタ条件をfilter_conditions（JSONB）で保存し、あとから同じ条件を再現できる。確定後のキャンセルはis_cancelledフラグの論理削除で対応。

確定された明細はt_billing_line_itemsにスナップショット保存される。確定時点の単価・パートナー名・IF名など全てコピーするため、後からマスタが変わっても請求データに影響しない。

### システム共通

監査ログはt_audit_logsでJSONB形式のold_value・new_valueを記録する。ポリモーフィック設計でoperator_typeによってエージェントかインフルエンサーかを区別する。月次パーティションで36個に分割済み。

通知はt_notificationsでuser_typeによる3種類のユーザー（エージェント・インフルエンサー・パートナー）に対応。

多言語はt_translationsでテーブル名・レコードID・カラム名・言語コードの組み合わせで翻訳を管理する。既存テーブルのカラムを変更せずに多言語化できる設計。

ファイル管理はt_filesでメタデータをDBに、実体はS3やGCSに格納する想定。entity_typeでインフルエンサー・パートナー・広告コンテンツなど紐付け先を区別するポリモーフィック設計。

BQ取り込みログはingestion_logsでジョブの実行状況を管理する。

## 設計の基本ルール

### データ型

文字列は全てTEXT。PostgreSQLではVARCHARとTEXTに性能差がないため、長さ制限はアプリ層で行う方針。日時は全てTIMESTAMPTZ（タイムゾーン対応）で統一。例外として単価の有効期間と住所の有効期間だけDATE型を使う。

### 主キー

原則GENERATED ALWAYS AS IDENTITY（自動採番）。少量の固定値マスタは手動採番、セキュリティテーブルは親のPKをそのまま使用、外部システムと連携するテーブルは外部IDに合わせる。

### 監査カラム

全テーブルにcreated_by、updated_by、created_at、updated_atを付与。updated_atは全テーブルにトリガーを設定して自動更新する。例外はt_audit_logsとingestion_logs（UPDATEされない設計のためトリガー不要）。

### 外部キーの削除ポリシー

RESTRICTが原則。参照先を安易に消せないようにする。CASCADEはインフルエンサーの従属データ（住所・口座など）と1対1のセキュリティテーブルに限定。SET NULLは任意参照（パートナーがIFを兼ねるケースなど）に使う。

### 楽観ロック

同時編集が想定されるm_influencers、m_campaigns、t_unit_pricesにversionカラムを設けている。更新時にバージョンを確認し、競合を検出する。

### ソフトデリート

主要マスタはstatus_idで状態管理。請求確定のキャンセルだけis_cancelledのBOOLEAN＋CHECK制約で論理削除。

## SQLファイルの構成

5本のSQLで全て実行可能。

1本目のcreate_tablesが約1000行で32テーブルとFK制約を定義。2本目のcreate_indexesが298行で複合インデックス・部分インデックス・GINインデックスを作成。3本目のcreate_commentsが473行で全テーブル・主要カラムにコメントを付与。4本目のcreate_triggersが75行でupdated_at自動更新の関数と30個のトリガーを定義。5本目のcreate_partitionsが78行でパーティションを作成する。

## 要件変更の経緯

プロジェクト開始から現在まで、7つの大きな要件変更があった。

システム名称がAFADからANSEMに変わった。インフルエンサーの重複統合は自動マージから手動削除に方針転換した。グループYouTuberのように1人が複数アカウントを持つケースが複雑すぎるため。MVPスコープからトータルマーケットを除外した。トータルマーケットの単価は頻繁に変動し、MVPには重すぎる。

データの「正」の定義も変わった。当初はANSEMが唯一の正と考えていたが、実際にはスプシの「調理」工程（0A〜0Fシート）が存在し、その加工ロジックもシステムに取り込む必要があった。

CSV出力ではパートナーIDの重複問題が発覚。コロン区切りや3桁の重複番号への対応が必要になった。計測粒度はパートナーサイトID単位に移行し、インフルエンサー単価はMVPスコープ外とした。

## データ投入の方針

既存のスプシデータはクレンジングして移行するのではなく、ゼロから入れ直す方針をとった。既存データが汚すぎて整合性を保証できないため。

投入方法は2つ。個別登録は管理画面のフォームから1件ずつ。一括登録はGoogleスプシでデータを準備し、CLIツール（ansem-import）で投入する。

一括登録用のスプシテンプレートは25列。基本情報（担当者・名前・コンプラチェック・区分・所属・敬称・メール・ジャンル）、SNS情報（Instagram・YouTube・Twitter・TikTok・その他）、銀行口座（銀行名・支店・種別・口座番号・口座名義）、請求先と住所（請求書番号・請求先・部署・郵便番号・住所・届先名・電話）で構成される。

投入順序はFK依存に従う。まずエンジニアが国・部署・カテゴリ・役割・SNSプラットフォームの初期データを入れる。次にエージェント情報。その後、クライアント・広告グループ・インフルエンサーを一括登録の主対象として投入し、パートナーやキャンペーンが続く。

## 一括登録CLIツール ansem-import

一括登録は初回移行だけでなく、月次の新規IF追加、案件開始時のIF一括登録、定期的な情報更新にも継続的に使う。

```bash
ansem-import --table influencers --file data.csv --dry-run  # DRY RUN（確認のみ）
ansem-import --table influencers --file data.csv             # 本番投入
```

YAML設定ファイルで対象テーブル・カラムマッピング・バリデーションルールを定義する。全テーブルに拡張可能な汎用設計。

Phase 1ではエンジニアがSQL直接投入、Phase 2でCLI運用、Phase 3でWebUIからの一括登録に進化させる。

## 追加機能ロードマップ

14の追加機能を4つのPhaseに分けている。

Phase 1（初期構築）ではBQ自動取り込み、一括登録CLI、確認画面、検索・フィルタリングを実装する。BQ自動取り込みが最大の時短ポイントで、BigQueryからPostgreSQLへの日次パイプラインをCloud Schedulerで自動化する。

Phase 2（MVP）では請求確定フロー、CSV/Excelエクスポートを追加。請求確定は期間選択→フィルタ設定→プレビュー→確定→スナップショット保存という流れ。

Phase 3（運用改善）ではダッシュボード、単価管理UI、担当者アサイン管理、通知機能を追加する。

Phase 4（拡張）では権限管理（RBAC）、監査ログ閲覧画面、ファイル管理UI、多言語対応に取り組む。

## 設計レビューの経緯

v1.0から5回のメジャーバージョンアップを重ねた。レビュー指摘は累計23件、全て対応済み。

v1.0ではプレフィックス不統一、ER図リレーション誤り、命名規約違反などの基本的な問題があった。v2.0〜v3.0で命名統一、ソフトデリート方針統一、パスワードソルトの削除などを実施。v4.0で楽観ロック、自動更新トリガー、ON DELETE使い分けルールの明文化を完了。v5.0でスケーリング対応（パーティション、PgBouncer、リードレプリカ）、多言語対応、ファイル管理を追加した。

v5.1ではCOMMENTの不整合修正、セキュリティテーブル間のカラム差異統一、entity_type番号統一など細かい品質改善を行い、品質スコアを8.5から9.2に引き上げた。

## スケーリング戦略

将来のデータ量増大に備えて4つの施策を設計に盛り込んでいる。

接続プーリングはPgBouncerでトランザクションプーリングを行い、同時接続数を制御する。読み取り負荷の分散にはリードレプリカを使い、ダッシュボードや検索クエリを分離する。

パーティションは日次集計テーブルを年次、監査ログを月次で分割する。アーカイブ戦略として3年以上前のデータはコールドストレージに移行する方針。

## 技術スタック

データベースはPostgreSQL 14以上。データパイプラインはGoogle BigQuery。一括登録CLIはPython。オブジェクトストレージはS3またはGCS。ER図の作成にはMermaid記法を使用。

## ドキュメント構成

```
team/guchi/projects/If-DB/
├── テーブル定義/ANSEM-ER図.md              ← DB設計書本体（DDL v5.4.0）
├── ER図/ANSEM-ER図（ビジュアル版）.md       ← Mermaid ER図
├── レビュー結果/ANSEM-ER図レビュー.md       ← 設計レビュー全記録
├── レビューガイド/ANSEM-DB設計レビューガイド.md ← レビューフロー
├── ANSEM-データ投入運用方針.md              ← 投入方針・テンプレート
├── ANSEM-一括登録機能メモ.md               ← CLIツール設計
├── ANSEM-追加機能ロードマップ.md            ← Phase 1〜4の機能計画
├── ANSEM-要件変更ログ.md                   ← 要件変更の経緯
├── ANSEM-プロジェクト全体サマリー.md         ← この文書
└── sql/                                    ← 実行可能なDDL（5本）
    ├── 001_create_tables.sql
    ├── 002_create_indexes.sql
    ├── 003_create_comments.sql
    ├── 004_create_triggers.sql
    └── 005_create_partitions.sql
```

---

_NotebookLM動画作成用の全体サマリー_
_プロジェクトバージョン: v5.4.0_
_作成日: 2026-02-13_
_Tags: #ansem #if-db #summary #notebooklm_
