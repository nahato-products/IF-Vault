---
tags: [ANSEM, feature, roadmap, memo]
created: 2026-02-12
updated: 2026-02-12
status: draft
related: "[[ANSEM-ER図]], [[ANSEM-一括登録機能メモ]], [[ANSEM-データ投入運用方針]], [[ANSEM-要件変更ログ]]"
---

# ANSEM 追加機能ロードマップ

> [!NOTE]
> DB設計（v5.4.0 / 32テーブル）は完了済み。
> ここではDB設計から逆算した「必要な機能」を優先度別に整理する。

---

## 優先度マップ

```
【MVP必須】         【あると便利】       【将来対応】
BQ自動取り込み       ダッシュボード       権限管理(RBAC)
一括登録             単価管理UI          監査ログ閲覧
確認画面             担当者アサイン管理    ファイル管理
請求確定フロー       通知機能            多言語対応
CSV/Excelエクスポート
検索・フィルタリング
```

---

## MVP必須（ないと運用回らない）

### 1. BQデータ自動取り込み 🥇

| 項目 | 内容 |
|------|------|
| 概要 | BigQuery → PostgreSQL の日次データパイプライン |
| 関連テーブル | `ingestion_logs`, `t_daily_performance_details`, `t_daily_click_details` |
| 効果 | スプシの「調理」工程（0A→0F）がまるごと不要に。最大の時短ポイント |
| 必要な実装 | BQ APIクライアント、差分取り込みロジック、エラーハンドリング、リトライ |
| 備考 | `ingestion_logs` でジョブ管理済み。スケジューラー（Cloud Scheduler等）と連携 |

### 2. 一括登録（CLIツール `ansem-import`）

| 項目 | 内容 |
|------|------|
| 概要 | スプシ → CSVダウンロード → CLIツール → DB投入 |
| 関連テーブル | `m_influencers`（最優先）、他マスタテーブル、`ingestion_logs`（実行記録） |
| 効果 | 既存スプシからの移行＋**今後の継続的なデータ投入**。非エンジニアでもデータ投入可能に |
| 特徴 | 初回移行だけでなく月次・案件開始時・随時の一括登録に対応。YAML設定で全テーブル拡張可能 |
| 詳細 | → [[ANSEM-一括登録機能メモ]] 参照 |

### 3. 請求確定フロー 🥉

| 項目 | 内容 |
|------|------|
| 概要 | 期間選択 → フィルタ設定 → プレビュー → 確定 → スナップショット保存 |
| 関連テーブル | `t_billing_runs`, `t_billing_line_items`, `t_daily_performance_details` |
| 効果 | 請求データの確定・取消が安全にできる。監査対応 |
| フロー | 1. 対象期間を選択 → 2. パートナー/サイト等でフィルタ → 3. 金額プレビュー → 4. 確定ボタン → 5. filter_conditionsとスナップショットを保存 |
| 備考 | 論理削除（is_cancelled）で取消対応。CHECK制約で整合性保証 |

### 4. CSV/Excelエクスポート

| 項目 | 内容 |
|------|------|
| 概要 | 集計データ・請求データのCSV/Excel出力 |
| 関連テーブル | `t_daily_performance_details`, `t_billing_line_items` |
| 効果 | 「計算結果の出力」が元々の要件。経理・管理部への共有用 |
| 注意 | パートナーID重複・コロン区切り問題への対応が必要（要件変更#5） |

### 5. 検索・フィルタリング

| 項目 | 内容 |
|------|------|
| 概要 | 全マスタテーブルの検索・絞り込み機能 |
| 関連テーブル | 全マスタテーブル |
| 効果 | 会議で要望あり: 「担当者単位の絞り込み」「猿でもできるUI」 |
| 必要な実装 | テキスト検索、ステータスフィルタ、日付範囲、ソート |

### 6. 確認画面の表示機能

| 項目 | 内容 |
|------|------|
| 概要 | 一括登録・請求確定など、データ変更前に確認画面を表示して操作者に最終確認させる |
| 対象操作 | 一括登録（CSVインポート前）、請求確定（確定ボタン押下前）、単価変更、担当者変更 等 |
| 表示内容 | 変更対象の件数、変更前後の差分プレビュー、バリデーションエラーの一覧、警告（重複・上書き等） |
| 効果 | 誤登録・誤確定の防止。運用担当者が安心してデータ操作できる |
| フロー | 1. データ入力/アップロード → 2. バリデーション実行 → 3. 確認画面（差分・エラー・警告を表示） → 4. 「実行」or「キャンセル」 → 5. 実行後に結果サマリ表示 |
| 備考 | CLIツール（ansem-import）のDRY RUNモードがこの役割を担う。WebUI化時には画面として実装 |

---

## あると運用がラクになる

### 7. ダッシュボード 🥈

| 項目 | 内容 |
|------|------|
| 概要 | CV・クリックの集計データを可視化 |
| 関連テーブル | `t_daily_performance_details`, `t_daily_click_details` |
| 表示内容案 | 日次/月次CV推移、パートナー別実績、クライアント別売上、前月比 |

### 8. 単価管理UI

| 項目 | 内容 |
|------|------|
| 概要 | サイト×コンテンツ×クライアント別の単価設定画面 |
| 関連テーブル | `t_unit_prices` |
| 備考 | 楽観ロック（version）実装済み。期間管理（start_at/end_at）あり |

### 9. 担当者アサイン管理

| 項目 | 内容 |
|------|------|
| 概要 | どのエージェントがどのIFを担当しているか管理 |
| 関連テーブル | `t_influencer_agent_assignments`, `m_agent_role_types` |
| 備考 | is_active + assigned_at/unassigned_at で履歴管理対応済み |

### 10. 通知機能

| 項目 | 内容 |
|------|------|
| 概要 | 各種イベントのプッシュ通知 |
| 関連テーブル | `t_notifications` |
| トリガー候補 | 新規IF登録、請求確定完了、担当者変更、データ取り込み完了/失敗 |
| 備考 | テーブルはあるが、何をトリガーに飛ばすかは要定義 |

---

## 将来対応

### 11. 権限管理（RBAC + RLS）

| 項目 | 内容 |
|------|------|
| 概要 | ロールベースのアクセス制御 + 行レベルセキュリティ |
| 設計状況 | `006_create_roles.sql` として別途作成予定（ansem_app / ansem_readonly / ansem_admin） |
| RLS対象 | m_influencers（担当エージェント別）、t_audit_logs（操作者別）等。RBACのロール定義後に一括実装 |

### 12. 監査ログ閲覧画面

| 項目 | 内容 |
|------|------|
| 概要 | 「誰がいつ何を変えた」を検索・閲覧 |
| 関連テーブル | `t_audit_logs`（月次パーティション済み） |

### 13. ファイル管理

| 項目 | 内容 |
|------|------|
| 概要 | プロフィール画像・契約書PDF等のアップロード/ダウンロード |
| 関連テーブル | `t_files`（メタデータDB + 実体はS3/GCS） |

### 14. 多言語対応

| 項目 | 内容 |
|------|------|
| 概要 | 海外IF向けにUI・データの多言語化 |
| 関連テーブル | `t_translations` |

---

## 開発順序の提案

```
Phase 1（初期構築）
  ├── BQ自動取り込み
  ├── 一括登録CLIツール（ansem-import）← 継続利用する基盤
  ├── 確認画面（CLIではDRY RUN、WebUIでは画面表示）
  └── 検索・フィルタリング

Phase 2（MVP）
  ├── 請求確定フロー
  ├── CSVエクスポート
  └── ダッシュボード

Phase 3（運用改善）
  ├── 単価管理UI
  ├── 担当者管理
  ├── 通知
  └── 一括登録のWebUI化（Phase 1のCLIロジックを再利用）

Phase 4（拡張）
  └── RBAC + RLS（Row-Level Security） + 監査ログ閲覧 + ファイル管理 + 多言語
```

---

_作成: 2026-02-12_
_ステータス: ドラフト_
