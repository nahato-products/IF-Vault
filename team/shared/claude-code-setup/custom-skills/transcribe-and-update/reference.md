# transcribe-and-update Reference

## 依存ツール・環境変数

| 名前 | パス / キー | 用途 |
|------|------------|------|
| `ptrans.sh` | `~/.claude/scripts/ptrans.sh` | 音声→テキスト変換（Whisper API） |
| `OPENAI_API_KEY` | 環境変数 | Whisper API認証 |
| Notion MCP | Claude Code MCP設定 | 既存議事録の取得・更新 |

## コマンドリファレンス

### ptrans.sh

```bash
~/.claude/scripts/ptrans.sh <audio-file> [options]
  --language ja        # 言語指定
  --json               # JSON形式で出力
  --out /tmp/claude/transcript.json  # 出力先
  --prompt "固有名詞リスト"           # 認識精度向上用プロンプト
```

### Notion MCP ツール

| ツール | 引数 | 戻り値 |
|--------|------|--------|
| `notion-fetch` | `page_id` | Markdown形式のページ内容 |
| `notion-update-page` | `page_id`, `content` | 更新結果 |
| `notion-search` | キーワード | マッチするページ一覧 |

> **Note**: Notionページ履歴は標準UI機能で復元可能。API経由での履歴取得は不可。

## パターン辞書

### 議題キーワード抽出

既存議事録の見出しからキーワードを抽出し、文字起こしセグメントとマッチング。

```regex
# 見出しからキーワード抽出
^#{2}\s*[0-9]*\.?\s*(.+)
# 例: "## 1. 要件定義の確認" → "要件定義"
```

### セグメント分類パターン

#### 決定事項

```regex
〜(に決定|でいく|にしましょう|ということで|で進め|で確定)
(決まり|結論として|合意)
```

例: 「SLAに追加することに決定」「結論としてAプランで進めます」

#### TODO

```regex
〜(お願い|対応する|やっておきます|確認します|共有します)
〜(までに|を期限に|期限[:：])
```

例: 「SLA案の作成お願いします」「金曜までに共有します」

#### 質問・回答

| 分類 | パターン | 例 |
|------|---------|-----|
| 質問 | `〜ですか？` `〜でしょうか` | 「モバイル対応は必須ですか？」 |
| 回答 | `〜です` `〜になります` | 「iPadでの利用が多いです」 |

#### 補足情報（数字・日付・固有名詞）

```regex
[0-9]+[秒分時間日週月年%％]
[0-9]+/[0-9]+
(具体的には|例えば|実際には)
```

例: 「2秒以内を希望」「具体的にはSlack連携が必要」

### 重複判定ルール

- 同一議題セクション内でキーフレーズ（名詞+動詞の組み合わせ）が一致 → **重複として除外**
- 数字・日付が異なる場合 → **詳細化として追記**（既存を残し新情報を追加）
- 既存と矛盾する場合 → **両方併記**して `[録音確認]` マーカー付与

### マージマーカー一覧

| マーカー | 意味 | 用途 |
|----------|------|------|
| `[🎙️]` | 録音から追加 | 決定事項・TODOの追記 |
| `[録音確認]` | 既存内容と矛盾 | 両方併記してユーザー判断 |
| `### 🎙️ 録音から追加` | 補足セクション | 各議題末尾に挿入 |
| `## その他（録音から追加）` | マッチなし | 議題にマッチしない情報 |

### マージ済みMarkdownテンプレート

```markdown
## 1. [議題名]

概要: [既存の概要]

[既存の議論内容]

### 🎙️ 録音から追加
- [発言者]: [追加内容]
- [発言者]: [追加内容]

### 決定事項
- [既存の決定事項]
- [🎙️] [録音から追加された決定事項]

### TODO
- [ ] [既存TODO]
- [ ] [🎙️] [担当] [新TODO] [期限]
```

## トラブルシューティング

| エラー | 原因 | 対処 |
|--------|------|------|
| 既存議事録が見つからない | ページID不正 or 削除済み | `notion-search` でキーワード再検索 |
| 議題がマッチしない | 見出しとトピックの乖離 | 「その他（録音から追加）」セクションに追加 |
| 録音品質が悪い | ノイズ・小声 | 低信頼度箇所に `[要確認]` マーク |
| 大量の差分 | 長時間MTG or 骨子が少ない | セクション単位でユーザーに確認 |
| ptrans.sh エラー | `OPENAI_API_KEY` 未設定 | `export OPENAI_API_KEY=...` を確認 |
| Notion更新失敗 | MCP接続エラー | MCP設定を確認、再接続 |
| マージで既存内容が消える | 上書き更新してしまった | Notionページ履歴（UI）から復元 |
