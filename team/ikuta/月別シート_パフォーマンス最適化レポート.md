# 月別シート パフォーマンス最適化 総合レポート

**対象:** [コピー]【8期】固定Unit_月別詳細 のコピー（テストコピー）
**実行日:** 2026年2月19日
**対象シート:** 2026年02月 / 2026年03月

---

## 結論

**3月シート（1,026行）の再計算速度が平均29%改善、中央値で37%改善。**

| 指標 | Before（未最適化） | After（最適化済） | 改善率 |
|------|-------------------|------------------|--------|
| 平均 | 870ms | **621ms** | **-29%** |
| 中央値 | 871ms | **553ms** | **-37%** |
| 最小 | 732ms | 463ms | -37% |
| 最大 | 994ms | 921ms | -7% |
| 標準偏差 | 110ms | 162ms | — |

最適化後は全ラウンドで1秒以内、5回中4回が700ms未満。テスターからも「すごく動きます！前よりもめっちゃスムーズです！」とフィードバックあり。

---

## Before/After 負荷テスト詳細

同一条件（5ラウンド、3セル/回、F列書き込み、500ms冷却）で実施。

### Before（本番コピー・未最適化）

| ラウンド | 再計算時間 | 書き込み行 |
|---------|-----------|-----------|
| 1 | 732ms | 行435, 662, 460 |
| 2 | 990ms | 行144, 75, 831 |
| 3 | 871ms | 行975, 812, 173 |
| 4 | 764ms | 行134, 78, 302 |
| 5 | 994ms | 行332, 438, 334 |
| **平均** | **870ms** | |

### After（テストコピー・最適化済）

| ラウンド | 再計算時間 | 書き込み行 |
|---------|-----------|-----------|
| 1 | 553ms | 行469, 154, 43 |
| 2 | 517ms | 行792, 285, 886 |
| 3 | 651ms | 行940, 49, 586 |
| 4 | 921ms | 行793, 684, 357 |
| 5 | 463ms | 行329, 99, 997 |
| **平均** | **621ms** | |

---

## 最適化内容

5つの最適化ステップを設計し、2月・3月それぞれに適用した。

| Step | 内容 | 2月 (165行) | 3月 (1,026行) |
|------|------|------------|--------------|
| 1 | ArrayFormula分離 | ✅ | ✅ |
| 2 | XLOOKUP集約（_cache方式） | ✅ | ❌ 大規模データで不安定 |
| 3 | CV検索キー集約 | ✅ | ✅ |
| 4 | LETキャッシュ化 | ❌ | ⏭ スキップ |
| 5 | 源泉徴収簡約 | ✅ | ✅ |
| **成功** | | **4/5** | **3/5** |

3月でStep 2が適用できなかった分、2月よりも最適化の恩恵は小さいが、Step 1（ArrayFormula分離）の効果が大きく、十分な改善が得られた。

全セル検証（3月: 28,742セル）で計算結果が改善前と完全一致していることを確認済み。

---

## 評価

### 良い点

- **再計算が平均29%高速化**: 870ms → 621ms。中央値ベースでは37%改善（871ms → 553ms）
- **全ラウンドで1秒以内**: 最適化後は5回中4回が700ms未満
- **計算結果の正確性**: 28,742セル全てで改善前と完全一致。最適化による計算ミスはゼロ
- **テスターの体感も良好**: 実際に操作した人から「めっちゃスムーズ」との評価

### 注意点

- **ばらつきの増加**: 最適化後の標準偏差162ms（Before: 110ms）。Round 4の921msのように、たまに遅くなることがある
- **同時編集時の影響は未検証**: 今回のテストは単一ユーザーでの計測。複数人が同時に編集した場合、さらに遅くなる可能性がある
- **Step 2が3月に適用できていない**: これが適用できれば更なる改善が見込める。将来的にバッチ分割などの改善を検討する余地がある

### 本番適用に向けて

このテストコピーで確認された改善は、本番スプレッドシートにも同じスクリプトで適用可能。ただし以下を推奨:

1. **本番適用前にバックアップ**: 本番シートのコピーを作成してから適用
2. **dryRun=trueで検証**: まずドライランで確認してからdryRun=falseで本適用
3. **同時編集の注意喚起**: 最適化後も、多人数が同時に重い操作をすると遅延が起こりうる旨を共有

---

## 参考: measurePerformance（全体再計算）

数式ダミー書き換え → flush() → 全セル読み取りを含む総合計測（最適化後のみ実施）。

| シート | データ行 | 再計算時間 |
|--------|---------|-----------|
| 2月 | 165行 | 2,239ms |
| 3月 | 1,026行 | 2,727ms |

---

## 技術情報

- スクリプト: `monthly_optimizer.gs`（Apps Scriptプロジェクト内）
- 負荷テスト: `無題.gs`（`runLoadTest()`）
- Before計測: 本番スプレッドシートのコピー（未改修）で実施
- After計測: テストコピー（最適化済み）で実施
- OPT_CONFIG: 現在3月設定（dryRun=true）
- 全ステップに自動ロールバック機構あり（Step 2で3回実証済み）
