# 月別シートの関数洗い出し（2026年02月）

## 概要

月別シート（2026年02月）で使用されている関数を洗い出し、整理する。

> [!abstract] 統計
> - 抽出セル数: **45個**
> - 参照先シート: `マスター原本`, `◆CV`, `◆list`
> - 主要関数: `ArrayFormula`, `XLOOKUP`, `SUM`, `IFERROR`, `LET`

---

## 関数インデックス（全45セル）

| # | セル | 関数の冒頭 | カテゴリ |
|---|------|-----------|---------|
| 1 | N2 | `SUMPRODUCT(ISERROR(...))` | エラー集計 |
| 2 | S2 | `SUM(S5:S)` | 集計 |
| 3 | T2 | `SUM(T5:T)` | 集計 |
| 4 | Z2 | `SUM(Z5:Z)` | 集計 |
| 5 | AA2 | `SUM(AA5:AA)` | 集計 |
| 6 | AH2 | `SUM(AH5:AH)` | 集計 |
| 7 | AI2 | `SUM(AI5:AI)` | 集計 |
| 8 | AJ2 | `SUM(AJ170:AJ)` | 集計 |
| 9 | AL2 | `SUM(AL170:AL)` | 集計 |
| 10 | AN2 | `SUM(AN170:AN)` | 集計 |
| 11 | AP2 | `SUM(AP170:AP)` | 集計 |
| 12 | BE2 | `SUM(BE170:BE)` | 集計 |
| 13 | BF2 | `SUM(BF170:BF)` | 集計 |
| 14 | BO2 | `SUM(BO5:BO169)` | 集計 |
| 15 | F5 | `ArrayFormula(E5:E&G5:G)` | 文字列結合 |
| 16 | H5 | `ArrayFormula(XLOOKUP(...))` | マスタ参照 |
| 17 | I5 | `ArrayFormula(XLOOKUP+REGEXMATCH)` | SNSアカウント参照 |
| 18 | S5 | `ArrayFormula(IF+乗算)` | 売上計算 |
| 19 | T5 | `ArrayFormula(IF+条件分岐)` | 利益計算 |
| 20 | U5 | `ArrayFormula(LET+XLOOKUP)` | CV参照（◆CV!F列） |
| 21 | V5 | `ArrayFormula(LET+XLOOKUP)` | CV参照（◆CV!G列） |
| 22 | W5 | `ArrayFormula(LET+XLOOKUP)` | CV参照（◆CV!H列）+手動上書き |
| 23 | Y5 | `ArrayFormula(W/U)` | CV率計算 |
| 24 | Z5 | `ArrayFormula(IF+条件)` | 確定売上 |
| 25 | AA5 | `ArrayFormula(IF+減算)` | 確定利益 |
| 26 | AB5 | `ArrayFormula(XLOOKUP)` | マスタ参照（I列） |
| 27 | AC5 | `ArrayFormula(XLOOKUP)` | マスタ参照（J列） |
| 28 | AE5 | `ArrayFormula(ROUNDUP+税計算)` | 源泉徴収計算 |
| 29 | AG5 | `ArrayFormula(ROUNDUP+税計算)` | 源泉徴収計算 |
| 30 | AH5 | `ArrayFormula(IF+加算)` | IF報酬合計 |
| 31 | AI5 | `ArrayFormula(減算)` | 差引計算 |
| 32 | AR5 | `ArrayFormula(XLOOKUP)` | マスタ参照（K列） |
| 33 | AT5 | `ArrayFormula(XLOOKUP)` | マスタ参照（L列） |
| 34 | AW5 | `ArrayFormula(XLOOKUP)` | マスタ参照（M列） |
| 35 | AX5 | `ArrayFormula(XLOOKUP)` | マスタ参照（N列） |
| 36 | AY5 | `ArrayFormula(XLOOKUP)` | マスタ参照（O列） |
| 37 | AZ5 | `ArrayFormula(XLOOKUP)` | マスタ参照（P列） |
| 38 | BA5 | `ArrayFormula(XLOOKUP)` | マスタ参照（Q列） |
| 39 | BC5 | `ArrayFormula(XLOOKUP)` | マスタ参照（S列） |
| 40 | BD5 | `ArrayFormula(IF+REGEXMATCH)` | 口座バリデーション |
| 41 | BE5 | `ArrayFormula(IF+IFERROR)` | 確定CV関連 |
| 42 | BF5 | `ArrayFormula(ROUND+IF)` | 手数料計算 |
| 43 | BG5 | `ArrayFormula(IF+条件)` | 成果判定 |
| 44 | BN5 | `ArrayFormula(XLOOKUP)` | マスタ参照 |
| 45 | BO5 | `ArrayFormula(S-(AF*R))` | 差額計算 |

---

## カテゴリ別分類

### 1. ヘッダー集計系（2行目: 14セル）

シート上部の合計値。各列の合計を表示する。

| セル | 関数 | 用途 |
|------|------|------|
| N2 | `=SUMPRODUCT(ISERROR(B3:BD3)*1) + SUMPRODUCT(ISERROR(B5:BD)*1)` | エラーセル数のカウント |
| S2 | `=SUM(S5:S)` | 売上合計 |
| T2 | `=SUM(T5:T)` | 利益合計 |
| Z2 | `=SUM(Z5:Z)` | 確定売上合計 |
| AA2 | `=SUM(AA5:AA)` | 確定利益合計 |
| AH2 | `=SUM(AH5:AH)` | IF報酬合計 |
| AI2 | `=SUM(AI5:AI)` | 差引合計 |
| AJ2 | `=SUM(AJ170:AJ)` | 集計（170行目以降） |
| AL2 | `=SUM(AL170:AL)` | 集計（170行目以降） |
| AN2 | `=SUM(AN170:AN)` | 集計（170行目以降） |
| AP2 | `=SUM(AP170:AP)` | 集計（170行目以降） |
| BE2 | `=SUM(BE170:BE)` | 確定CV関連合計 |
| BF2 | `=SUM(BF170:BF)` | 手数料合計 |
| BO2 | `=SUM(BO5:BO169)` | 差額合計 |

> [!NOTE]
> AJ2, AL2, AN2, AP2, BE2, BF2 は **170行目以降** から集計開始。
> 5行目からではなく170行目からなのは、手入力エリアや別区画がある可能性あり。

---

### 2. マスタ参照系（XLOOKUP: 14セル）

`マスター原本` シートからデータを引っ張ってくる。検索キーは `E列（IF名?）& BB列` → `マスター原本!B列 & R列(7桁)` のパターンが共通。

| セル | 参照先カラム | 推定用途 |
|------|------------|---------|
| H5 | `マスター原本!C列` | IF名称? |
| I5 | `マスター原本!D〜H列`（SNS分岐） | SNSアカウント情報 |
| AB5 | `マスター原本!I列` | 支払区分（③2割引き等） |
| AC5 | `マスター原本!J列` | 支払関連情報 |
| AR5 | `マスター原本!K列` | 不明（要確認） |
| AT5 | `マスター原本!L列` | 不明（要確認） |
| AW5 | `マスター原本!M列` | 不明（要確認） |
| AX5 | `マスター原本!N列` | 不明（要確認） |
| AY5 | `マスター原本!O列` | 口座：金融機関名? |
| AZ5 | `マスター原本!P列` | 口座：支店名? |
| BA5 | `マスター原本!Q列` | 口座：口座種別? |
| BC5 | `マスター原本!S列` | 口座：口座番号? |
| BN5 | `マスター原本!?列` | 不明（要確認） |

> [!IMPORTANT]
> **共通検索キーパターン:**
> ```
> E5:E & BB5:BB  →  マスター原本!B:B & TEXT(マスター原本!R:R, "0000000")
> ```
> `BB列`の値と`マスター原本!R列`を7桁ゼロ埋めで突合している。

---

### 3. CV参照系（LET + XLOOKUP: 3セル）

`◆CV` シートからコンバージョンデータを取得。`LET`関数で変数定義してから`XLOOKUP`で検索。

| セル | 参照先 | 用途 |
|------|--------|------|
| U5 | `◆CV!F列` | CV値1 |
| V5 | `◆CV!G列` | CV値2 |
| W5 | `◆CV!H列` | CV値3（手動上書き対応: X列が空でなければX列を優先） |

**検索キー構造（5つの項目を結合）:**

```
text(B2,"YYMM") & M5:M(client) & L5:L(prod) & agent(◆listから取得) & F5:F(ifName)
```

> [!NOTE]
> `agent` は `◆list` シートから取得:
> `XLOOKUP(MID(B5:B, 5, 10), '◆list'!F:F, '◆list'!E:E)`
> B列の5文字目から10文字をキーに `◆list` を検索。

---

### 4. 売上・利益計算系（7セル）

| セル | 関数概要 | ロジック |
|------|---------|---------|
| S5 | 売上計算 | `D列="予算/ボーナス"` → `N列`、それ以外 → `R列 × N列` |
| T5 | 利益計算 | `BG列="成果"` → `S列 - (R列 × AF列)`、それ以外 → `S列 - BF列` |
| Y5 | CV率 | `W列 / U列` |
| Z5 | 確定売上 | `Q列=TRUE` → `予算/ボーナスならN列、それ以外はN列×X列`、FALSE → 0 |
| AA5 | 確定利益 | `Q列=TRUE` → `Z列 - BF列`、FALSE → `Z列` |
| AI5 | 差引計算 | `AH列 - AJ列 - AL列 - AN列 - AP列` |
| BO5 | 差額計算 | `S列 - (AF列 × R列)` |

> [!TIP]
> **Q列** が「確定フラグ」として機能している（TRUE=確定、FALSE=未確定）。
> 確定時のみ手数料（BF列）を差し引く。

---

### 5. IF報酬・源泉徴収計算系（4セル）

| セル | 関数概要 | ロジック |
|------|---------|---------|
| AE5 | 源泉徴収後金額（固定費） | `ROUNDUP((AD/1.1) + (AD - AD/1.1) - (AD - AD/1.1)*0.2)` |
| AG5 | 源泉徴収後金額（成果費） | `ROUNDUP((AF/1.1) + (AF - AF/1.1) - (AF - AF/1.1)*0.2)` |
| AH5 | IF報酬合計 | `AB列="③2割引き"` → `AE列 + AG列×W列`、それ以外 → `AD列 + AF列×W列` |
| BF5 | 手数料計算 | `ROUND(IF(AB列による分岐))` |

> [!NOTE]
> **源泉徴収の計算ロジック:**
> ```
> 税抜 = 金額 / 1.1
> 消費税 = 金額 - 税抜
> 源泉税 = 消費税 × 0.2
> 結果 = ROUNDUP(税抜 + 消費税 - 源泉税)
> ```
> `AB列="③2割引き"` の場合は源泉徴収後の金額（AE, AG列）を使用。

---

### 6. 文字列結合・ID生成系（1セル）

| セル | 関数 | 用途 |
|------|------|------|
| F5 | `=ArrayFormula(E5:E & G5:G)` | E列とG列の結合（IF名+SNS種別?でユニークキー生成） |

---

### 7. SNSアカウント参照系（1セル）

#### I5: SNSプラットフォーム別の分岐参照

```
G列の値に応じてマスター原本の異なる列を参照:
├─ G列が空 or blank       → マスター原本!D列
├─ G列 = 2               → マスター原本!H列
├─ "Instagram" を含む     → マスター原本!D列
├─ "youtube" を含む       → マスター原本!E列
├─ "twitter" を含む       → マスター原本!F列
├─ "tiktok" を含む        → マスター原本!G列
└─ それ以外               → マスター原本!H列
```

> [!NOTE]
> マスター原本のカラム配置（推定）:
> - D列: Instagramアカウント
> - E列: YouTubeアカウント
> - F列: Twitterアカウント
> - G列: TikTokアカウント
> - H列: その他/デフォルト

---

### 8. バリデーション系（1セル）

#### BD5: 口座情報バリデーション

AY〜BC列（口座関連フィールド）のバリデーション:

```
チェック内容:
1. すべて空 → 空欄（エラーなし）
2. 空欄が混在 → "すべての欄に正しく入力してください"
3. 先頭が空 → "すべての欄に正しく入力してください"
4. 末尾が空 → "すべての欄に正しく入力してください"
5. BB列が7桁でない → "口座番号が7桁になっていません"
6. すべてOK → 口座情報を結合して表示
```

---

### 9. 成果判定系（1セル）

| セル | 関数概要 | 用途 |
|------|---------|------|
| BG5 | `IF((AD<>"")*(AF<>"")...)` | AD列・AF列の値から「成果」かどうかを判定 |

---

## シート構造の推定

```
行構造:
├─ 1行目: ヘッダー（非表示?）
├─ 2行目: 合計行（S2, T2, Z2 等の集計値）+ B2に年月日
├─ 3行目: ヘッダー?
├─ 4行目: ヘッダー?
├─ 5〜169行目: データ行（ArrayFormula で一括処理）
└─ 170行目以降: 別区画（AJ2等が170行目から集計）

列構造（推定）:
├─ B列: 管理コード（5文字目以降がエージェント識別子）
├─ D列: 種別（"予算/ボーナス" 等）
├─ E列: IF識別子（マスタ検索キーの一部）
├─ F列: E列&G列の結合キー
├─ G列: SNSプラットフォーム種別
├─ H列: IF名（マスタ参照）
├─ I列: SNSアカウント（プラットフォーム別）
├─ L列: 商品/prod
├─ M列: クライアント
├─ N列: 件数/数量
├─ Q列: 確定フラグ（TRUE/FALSE）
├─ R列: 単価
├─ S列: 売上（R×N）
├─ T列: 利益
├─ U〜W列: CV値（◆CVシート参照）
├─ X列: 手動CV入力
├─ Y列: CV率
├─ Z列: 確定売上
├─ AA列: 確定利益
├─ AB列: 支払区分（③2割引き等）
├─ AD列: IF固定報酬
├─ AE列: 源泉徴収後（固定）
├─ AF列: IF成果報酬（単価）
├─ AG列: 源泉徴収後（成果）
├─ AH列: IF報酬合計
├─ AI列: 差引額
├─ AJ,AL,AN,AP列: 控除項目?
├─ AR〜BC列: マスタ参照（口座情報等）
├─ BD列: 口座バリデーション
├─ BE列: 確定CV関連
├─ BF列: 手数料
├─ BG列: 成果判定フラグ
├─ BB列: マスタ検索キーの一部（7桁コード）
├─ BN列: マスタ参照
└─ BO列: 差額（S-(AF×R)）
```

---

## 参照先シート一覧

| シート名 | 用途 | 参照元セル |
|---------|------|-----------|
| `マスター原本` | IFマスタ情報（名前、SNS、口座、支払区分等） | H5, I5, AB5, AC5, AR5, AT5, AW5〜BC5, BN5 |
| `◆CV` | コンバージョンデータ | U5, V5, W5 |
| `◆list` | エージェントリスト | U5, V5, W5（内部でagent取得） |

---

## 気になる点・要確認事項

> [!WARNING]
> - AJ2, AL2, AN2, AP2, BE2, BF2 が **170行目以降** から集計しているのはなぜ？（5行目からではない）
> - `マスター原本` のK〜N列（AR5, AT5, AW5, AX5で参照）の内容が不明
> - `BG5` の完全な関数が途切れている（成果判定の全条件を確認すべき）
> - `BE5` の完全な関数が途切れている（確定CV計算の全容を確認すべき）
> - `BD5` の関数が途中で切れている（口座情報結合の最終形を確認すべき）

---
