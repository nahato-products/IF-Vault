name: Morning Scrum Generator

on:
  schedule:
    # JST 10:45 = UTC 01:45ÔºàÊúà„ÄúÈáë„ÅÆ„ÅøÔºâ
    - cron: '45 1 * * 1-5'
  workflow_dispatch: # ÊâãÂãïÂÆüË°å„ÇÇÂèØËÉΩ

jobs:
  create-scrum:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Generate date
        id: date
        run: |
          # JST„ÅÆÊó•‰ªò„ÇíÂèñÂæó
          echo "jst_date=$(TZ=Asia/Tokyo date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "jst_date_ja=$(TZ=Asia/Tokyo date +'%YÂπ¥%mÊúà%dÊó•')" >> $GITHUB_OUTPUT

      - name: Create scrum issue
        id: create_issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_URL=$(gh issue create \
            --repo ${{ github.repository }} \
            --title "„Çπ„ÇØ„É©„É† ${{ steps.date.outputs.jst_date }}" \
            --label "scrum" \
            --assignee hirokazukawamuro,zenntouyou-yabai \
            --body "# „Çπ„ÇØ„É©„É† ${{ steps.date.outputs.jst_date_ja }}

          ## üìã Êú¨Êó•„ÅÆ„Çø„Çπ„ÇØ‰∏ÄË¶ß
          ÂêÑËá™„ÅÆ„Çø„Çπ„ÇØ„ÇíÂÖ±Êúâ„Åó„Åæ„Åó„Çá„ÅÜ

          - [ ]

          ---

          ## üåà ‰ªäÈÄ±„ÅÆ„Çπ„Éó„É™„É≥„Éà„Ç¥„Éº„É´
          „ÉÅ„Éº„É†ÁõÆÊ®ô„ÇíÁ¢∫Ë™ç

          -

          ---

          ## üéØ ‰ªäÊó•„ÇÑ„Çã„Åì„Å®
          Êú¨Êó•„ÅÆ‰ΩúÊ•≠‰∫àÂÆö„ÇíÂÖ±Êúâ

          - [ ]

          ---

          ## üí¨ Ë©∞„Åæ„Å£„Å¶„Çã„Åì„Å® or „Éò„É´„ÉóÊ¨≤„Åó„ÅÑ„Åì„Å®
          „Éñ„É≠„ÉÉ„Ç´„Éº„ÇÑÁõ∏Ë´á‰∫ãÈ†Ö„ÇíÂÖ±Êúâ

          -

          ---

          ## ‚úÖ Êò®Êó•„ÇÑ„Å£„Åü„Åì„Å®
          Êò®Êó•„ÅÆÊàêÊûú„ÇíÂÖ±Êúâ

          - [ ]

          ---

          _„Åì„ÅÆ„Çπ„ÇØ„É©„É†„ÅØ GitHub Actions „Å´„Çà„ÇäËá™ÂãïÁîüÊàê„Åï„Çå„Åæ„Åó„Åü_")
          echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT

      - name: Notify Slack
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d '{
              "username": "„Çπ„ÇØ„É©„É†Bot",
              "icon_emoji": ":runner:",
              "text": "„Çπ„ÇØ„É©„É†ÈñãÂßãÔºÅüëÄ",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*„Çπ„ÇØ„É©„É†ÈñãÂßãÔºÅüëÄ*\n\n‰ªäÊó•„ÅÆ„Çø„Çπ„ÇØ„ÇíÂÖ±Êúâ„Åó„Åæ„Åó„Çá„ÅÜ üí™"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ steps.create_issue.outputs.issue_url }}|üìã „Çπ„ÇØ„É©„É†„ÇíÈñã„Åè>"
                  }
                }
              ]
            }'
