name: Daily Report Generator

on:
  schedule:
    # JST 19:00 = UTC 10:00ï¼ˆæœˆã€œé‡‘ã®ã¿ï¼‰
    - cron: '0 10 * * 1-5'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  create-daily-report:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Generate date
        id: date
        run: |
          # JSTã®æ—¥ä»˜ã‚’å–å¾—
          echo "jst_date=$(TZ=Asia/Tokyo date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "jst_date_ja=$(TZ=Asia/Tokyo date +'%Yå¹´%mæœˆ%dæ—¥')" >> $GITHUB_OUTPUT

      - name: Create daily report issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue create \
            --repo ${{ github.repository }} \
            --title "æ—¥å ± ${{ steps.date.outputs.jst_date }}" \
            --label "daily-report" \
            --body "# æ—¥å ± ${{ steps.date.outputs.jst_date_ja }}

          ## ğŸ“š å­¦ã‚“ã ã“ã¨ / æ°—ã¥ã

          - [ ]

          ---

          _ã“ã®æ—¥å ±ã¯ GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ_"

      - name: Notify Slack
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d '{
              "username": "NIPPOã•ã‚“",
              "text": "ğŸ“ æ—¥å ±ãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸ“ æ—¥å ±ãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼*\n\nä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šã‚’è¨˜éŒ²ã—ã¾ã—ã‚‡ã† ğŸ’ª"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<https://github.com/nahato-products/IF-Vault/issues?q=is:issue+label:daily-report+is:open+sort:created-desc|ğŸ“‹ æ—¥å ±ã‚’é–‹ã>"
                  }
                }
              ]
            }'
