name: Sprint Review Generator

on:
  schedule:
    # JST é‡‘æ›œ 17:00 = UTC é‡‘æ›œ 08:00
    - cron: '0 8 * * 5'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  create-sprint-review:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Generate date
        id: date
        run: |
          # JSTã®æ—¥ä»˜ã‚’å–å¾—
          echo "jst_date=$(TZ=Asia/Tokyo date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "jst_date_ja=$(TZ=Asia/Tokyo date +'%Yå¹´%mæœˆ%dæ—¥')" >> $GITHUB_OUTPUT

      - name: Create sprint review issue
        id: create_issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_URL=$(gh issue create \
            --repo ${{ github.repository }} \
            --title "ã‚¹ãƒ—ãƒªãƒ³ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼ ${{ steps.date.outputs.jst_date }}" \
            --label "sprint-review" \
            --body "# ã‚¹ãƒ—ãƒªãƒ³ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼ ${{ steps.date.outputs.jst_date_ja }}

          ## ã€ä»Šé€±ã®ç›®æ¨™ã€‘
          ã‚¹ãƒ—ãƒªãƒ³ãƒˆé–‹å§‹æ™‚ã«è¨­å®šã—ãŸç›®æ¨™ã‚’æŒ¯ã‚Šè¿”ã‚Šã¾ã—ã‚‡ã†

          -

          ---

          ## ã€ä»Šé€±ã®æˆæœã€‘
          å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯ã‚„å®Ÿè£…ã—ãŸæ©Ÿèƒ½ã‚’å…±æœ‰

          - [ ]

          ---

          ## ã€é”æˆç‡ã€‘
          é”æˆç‡: _%_

          ç›®æ¨™ã«å¯¾ã™ã‚‹é€²æ—çŠ¶æ³ã‚’ç¢ºèª

          ---

          ## ã€ãƒ™ãƒ­ã‚·ãƒ†ã‚£ã€‘
          ä»Šé€±: _pt_
          å¹³å‡: _pt_

          ãƒãƒ¼ãƒ ã®é€Ÿåº¦ã‚’æ¸¬å®š

          ---

          _ã“ã®ã‚¹ãƒ—ãƒªãƒ³ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ_")
          echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT

      - name: Notify Slack
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d '{
              "username": "ã‚¹ãƒ—ãƒªãƒ³ãƒˆBot",
              "icon_emoji": ":chart_with_upwards_trend:",
              "text": "ã‚¹ãƒ—ãƒªãƒ³ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ™‚é–“ã§ã™ï¼",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ã‚¹ãƒ—ãƒªãƒ³ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼ ğŸ“Š*\n\nä»Šé€±ã®æˆæœã‚’æŒ¯ã‚Šè¿”ã‚Šã¾ã—ã‚‡ã† ğŸ‰"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ steps.create_issue.outputs.issue_url }}|ğŸ“‹ ã‚¹ãƒ—ãƒªãƒ³ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‹ã>"
                  }
                }
              ]
            }'
