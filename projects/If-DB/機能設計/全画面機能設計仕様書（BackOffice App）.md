
本仕様書は、**ER図（v5.4.0）** の32テーブルを完全に準拠した実装を求めるものである。

### 1. 組織・エージェント管理（未実装・エラー解消対象）

- **部署画面 (`m_departments`)**:
    
    - **階層表示**: `parent_department_id` を使用し、事業部＞部門といった親子階層をインデント等で視覚的に表現する。
        
    - **ステータス**: `is_active` フラグにより有効/無効を切り替え可能にする。
        
- **エージェント画面 (`m_agents`, `m_agent_security`)**:
    
    - **CRUD**: 担当者の新規登録・編集。パスワード情報は `m_agent_security` へ保存する。
        
    - **所属紐付**: `department_id` を介して必ず部署に所属させる。
        

### 2. マスター管理

- **広告主画面 (`m_clients`)**:
    
    - **管理項目**: `client_name`, `industry`, `status_id` (取引中/停止)。
        
- **IF-担当紐付画面 (`t_influencer_agent_assignments`)**:
    
    - **履歴管理**: `m_influencers` と `m_agents` の多対多の紐付け。
        
    - **役割定義**: `m_agent_role_types` から「メイン/サブ/スカウト」などの役割を選択。
        

### 3. 広告・単価管理

- **広告マスター (`m_ad_groups`, `m_ad_contents`)**:
    
    - **階層構造**: 案件（AdGroup）の中に複数のコンテンツ（AdContent）がぶら下がる構造。
        
- **マッピング設定 (`t_partner_sites`)**:
    
    - **一括登録**: 未登録 `site_id` の自動検出およびCSVインポート（衝突解決画面を含む）。
        
- **単価管理 (`t_unit_prices`)**:
    
    - **多階層適用**: 「サイト×コンテンツ」等の優先順位ロジックの実装（前述の通り）。
        

### 4. 連携・請求・監査

- **AFADデータ (`ingestion_logs`, `t_daily_performance_details`)**:
    
    - **ログ表示**: BigQueryからの取込履歴を表示。
        
    - **成果確認**: 日次集計データの閲覧機能。
        
- **請求プレビュー (`t_billing_runs`, `t_billing_line_items`)**:
    
    - **集計実行**: 指定期間のCVを集計し、単価乖離アラート（±20%）を含むプレビューを表示。
        
    - **確定**: 確定ボタン押下で JSONB 形式のフィルタ条件と共にスナップショットを保存。
        
- **監査ログ (`t_audit_logs`)**:
    
    - **差分表示**: 全操作の `old_value`, `new_value` を比較形式で閲覧可能にする。
        

---

## 🤖 Claude Code への修復・実装指示（プロンプト）

現状の実装漏れとエラーを解消するため、以下の指示を厳守して実行してください。

### 1. 現状分析とルート整合性チェック

- **404エラーの解消**: `page-agents` 等への遷移で404が発生しています。アプリケーションのルーティング定義と、サイドバーのリンク先、コンポーネントの配置が一致しているか全件確認し、修正してください。
    
- **データ取得失敗の解消**: 部署画面等でデータ取得に失敗しています。**ER図（v5.4.0）** のカラム名と、API/SQLクエリが1文字も違わずに一致しているか確認してください（例：`department_id` と `dept_id` の取り違え等）。
    

### 2. 未実装画面の構築（ER図完全準拠）

- **部署 (`m_departments`)**: `parent_department_id` を使った親子階層表示を実装してください。
    
- **エージェント (`m_agents`)**: 所属部署とのJOIN、および `m_agent_security` との1対1連携を含むCRUDを実装してください。
    
- **広告主 (`m_clients`)**, **広告マスター (`m_ad_groups`)**: それぞれのマスター画面をER図の定義通りに作成してください。
    
- **マッピング設定・単価管理**: 前述の「CSV衝突解決プレビュー」および「多階層単価計算ロジック」を組み込んで一から構築してください。
    

### 3. 実装のルール（想像の禁止）

- **Single Source of Truth**: 実装は必ず **提供されたER図（v5.4.0）のカラム名と型** に従ってください。
    
- **確認事項**: ER図にないカラムが必要だと判断した場合や、HTMLモックとDB構造に矛盾を感じた場合は、勝手に補完せず必ず私に確認してください。
    
- **監査ログの徹底**: 全ての新規作成画面において、`t_audit_logs` への JSONB 形式の保存ロジックを漏れなく組み込んでください。
    

---

### 💡 アドバイス

この指示を投げると、Claude Codeはまずルーティングファイル（`routes.ts` や `App.tsx` 等）と、DBマイグレーションの整合性を確認し始めます。404が出ているということは、そもそもファイルの作成漏れか、URLのパス指定ミスである可能性が高いため、そこから修正させましょう。