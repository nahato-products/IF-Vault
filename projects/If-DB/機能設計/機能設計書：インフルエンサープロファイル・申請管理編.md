
### 1. プロフィール完成度ナビゲーションのロジック (`portal-main`)

モックに存在する「プロフィールの完成度」の計算式を定義し、機能として実装します。

- **計算ロジック (スコア配分例)**:
    
    - 基本情報 (`m_influencers`) の必須項目入力: **40%**
        
    - SNS連携 (`t_influencer_sns_accounts`) が1つ以上: **20%**
        
    - 住所 (`t_addresses`) が1つ以上: **20%**
        
    - 銀行口座 (`t_bank_accounts`) が1つ以上: **20%**
        
- **UI表示**: スコアに応じてプログレスバーを更新し、未完了項目を「あと少し！〇〇を登録しましょう」とナビゲートします。
    

### 2. 申請管理テーブル (`t_approval_requests`) の新設

ご提案の「Method 3（JSONBによる申請管理）」を具体化します。

|**カラム名**|**型**|**説明**|
|---|---|---|
|`request_id`|BIGINT (PK)|申請の一意なID|
|`target_table`|TEXT|申請対象テーブル名 (`m_influencers`, `t_addresses` 等)|
|`target_id`|BIGINT|更新対象のレコードID (新規登録時は NULL)|
|`old_value`|JSONB|変更前のレコード全データ|
|`new_value`|JSONB|申請された新しいレコード全データ|
|`status`|SMALLINT|1: 申請中, 2: 承認済み, 3: 却下, 4: 取消(申請者による)|
|`influencer_id`|BIGINT (FK)|申請したインフルエンサー|

### 3. 申請・上書き・ロックのフロー

インフルエンサー側（Portal）の操作ルールを定義します。

- **申請の上書きと解除**:
    
    - 「申請中 (status=1)」の状態では、Portal側の編集画面をロック（参照のみ）します。
        
    - インフルエンサーが内容を修正したい場合は、一度「申請を解除（status=4へ変更）」することで、再度編集・再申請が可能になります。
        
- **BackOfficeでの反映**:
    
    - 承認ボタン押下時、`new_value` の内容を対象テーブルに反映（INSERTまたはUPDATE）します。
        
    - 住所・口座が「メイン」として承認された場合、既存の `is_primary = TRUE` のレコードを自動的に `FALSE` へ更新します。
        

### 4. アプリケーション分離とセキュリティ

- **Portal App**: インフルエンサー本人による `t_approval_requests` の作成・取消のみ。
    
- **BackOffice App**: エージェントによる申請内容の比較（`old_value` vs `new_value`）と、承認・却下アクション。
    

---

## 💡 Claude Code への「橋渡し」プロンプト（例）

このドキュメントが完成したことで、Claude Codeに対して以下のように指示を出せるようになります。

> **プロンプト案:**
> 
> 「PortalアプリとBackOfficeアプリを分離して構築してください。
> 
> インフルエンサーの情報更新には `t_approval_requests` テーブルを使用した申請管理フロー（Method 3）を実装してください。
> 
> ポータル側のダッシュボードでは、ER図の各テーブルをカウントし、住所や口座が未登録なら完成度を下げるロジックを実装してください。
> 
> 詳細は『機能設計書：インフルエンサープロファイル・申請管理編』を参照してください。」

---
