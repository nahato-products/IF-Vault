
### 1. マッピング設定の自動検出と一括登録 (`page-mapping`)

AFAD（BigQuery）から取り込まれた生データとマスタの整合性を管理します。

- **未登録サイトの自動リストアップ**:
    
    - `t_daily_performance_details`（日次成果）に存在する `site_id` のうち、`t_partner_sites`（マスタ）に未登録のものを抽出し、ダッシュボードおよび設定画面で警告表示する。
        
- **CSV一括登録と衝突解決 (Conflict Resolution)**:
    
    - **CSVインポート**: `site_id`, `partner_id`, `site_name`, `unit_price` 等を含むファイルをアップロード可能とする。
        
    - **衝突確認UI**: `site_id` が既に存在する場合、DBの現在の値とCSVの値を並べて表示し、ユーザーが「上書き」か「維持」かを選択した上で実行する。
        
- **拡張性**:
    
    - 現時点では即時反映とするが、将来的に `status_id`（承認待ち）による制御を有効化できる構造にする。
        

### 2. 多階層単価計算エンジン (`t_unit_prices`)

成果報酬計算において、最も具体的な設定を優先して適用するロジックを実装します。

|**優先順位**|**設定階層**|**抽出条件 (WHERE)**|**用途**|
|---|---|---|---|
|**1 (最優先)**|**サイト × 案件**|`site_id` = X AND `content_id` = Y|特定のIFに対し、特定の案件のみ特別単価を適用|
|**2**|**サイト別デフォルト**|`site_id` = X AND `content_id` IS NULL|特定のIFの成果を一律単価とする場合|
|**3**|**案件別デフォルト**|`content_id` = Y AND `site_id` IS NULL|全サイト共通の標準案件単価|
|**4**|**広告主別デフォルト**|`client_id` = Z AND 他が NULL|クライアント単位の最低保証単価等|

### 3. 請求プレビューと異常検知 (`page-billing`)

請求確定前にデータの不整合や異常を検知します。

- **基本アラート**: 「未マッピングの `site_id`」および「適用期間外の単価未設定」をリストアップする。
    
- **単価乖離アラート (Anomaly Detection)**:
    
    - 設定された単価が、過去3ヶ月の `t_daily_performance_details` における平均単価（実績値）から **±20%以上逸脱** している場合に警告アイコンを表示する。
        

### 4. 監査ログ (`t_audit_logs`)

- マッピングおよび単価の全変更について、`old_value` / `new_value` を JSONB 形式で記録する。
    

---

## 🤖 Claude Code への実装指示プロンプト

BackOffice アプリケーションの「マッピング設定」画面および「請求プレビュー」の計算ロジックを実装してください。

### 1. マッピング管理画面の構築

- `if-db-ux.html` の `page-mapping` セクションを実装してください。
    
- `t_daily_performance_details` から未登録の `site_id` を自動検出し、警告リストとして表示してください。
    
- CSVインポート機能を実装してください。既存データと衝突する場合は、変更箇所をハイライトした確認画面を表示し、ユーザーが上書きを承認した場合のみ `t_partner_sites` を更新してください。
    

### 2. 単価計算エンジンの実装

- `t_unit_prices` を使用し、以下の優先度で単価を抽出する関数を実装してください。
    
    1. `site_id` + `content_id` 一致
        
    2. `site_id` 一致
        
    3. `content_id` 一致
        
- このロジックは請求プレビュー (`page-billing`) の金額計算に適用してください。
    

### 3. 請求プレビュー時の異常検知

- `page-billing` で集計を行う際、以下の警告を表示してください。
    
    - 単価が設定されていないレコード。
        
    - マッピングが完了していない `site_id`。
        
    - **単価乖離チェック**: 設定単価が過去の実績平均（`t_daily_performance_details` の `client_action_cost / cv_count`）から 20% 以上逸脱している場合。
        

### 4. 共通要件

- 操作は全て `t_audit_logs` に記録してください（JSONB形式で全カラムの変更前後を保持）。
    
- この機能は BackOffice アプリケーション限定とし、Portal アプリケーションからはアクセスできないように分離してください。
    

---

