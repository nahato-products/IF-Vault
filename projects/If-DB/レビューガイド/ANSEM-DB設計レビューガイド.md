---
tags: [ANSEM, review, guide, checklist]
created: 2026-02-12
updated: 2026-02-12
status: active
related: "[[ANSEM-ER図]], [[ANSEM-ER図（ビジュアル版）]], [[ANSEM-ER図レビュー]], [[ANSEM-データ投入運用方針]], [[ANSEM-一括登録機能メモ]], [[ANSEM-追加機能ロードマップ]]"
---

# ANSEM DB設計 レビューガイド

> [!NOTE]
> DB設計 v5.4.0（32テーブル）のレビューを依頼する際のガイドラインです。
> レビュアーが効率よく確認できるよう、フロー・対象ファイル・チェックポイントをまとめています。

---

## レビューフロー

```
┌─────────────────────────────────────────────────┐
│ Step 1: 全体像を把握（10分）                      │
│   → ビジュアル版ER図で全体の構造を掴む              │
└──────────────────────┬──────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│ Step 2: 設計方針を確認（10分）                     │
│   → 設計書の冒頭（方針・原則・命名規則）を読む       │
└──────────────────────┬──────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│ Step 3: テーブル詳細を確認（30分）                  │
│   → 気になるテーブルのDDL・インデックス・制約を確認   │
└──────────────────────┬──────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│ Step 4: 運用面を確認（10分）                       │
│   → データ投入方針・一括登録・ロードマップ           │
└──────────────────────┬──────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│ Step 5: フィードバック                             │
│   → 指摘・質問・承認をまとめる                      │
└─────────────────────────────────────────────────┘
```

---

## 対象ファイル一覧（読む順番）

### 必読（コアドキュメント）

| 順番 | ファイル | 内容 | 想定時間 |
|------|---------|------|---------|
| 1 | [[ANSEM-ER図（ビジュアル版）]] | ドメイン別Mermaid ER図。全体構造の把握に最適 | 10分 |
| 2 | [[ANSEM-ER図]] セクション1-4 | 設計方針・原則・命名規則・テーブル構成一覧 | 10分 |
| 3 | [[ANSEM-ER図]] セクション5以降 | 各テーブルのDDL詳細（気になる箇所のみ） | 30分 |

### 推奨（運用・機能方針）

| 順番 | ファイル | 内容 | 想定時間 |
|------|---------|------|---------|
| 4 | [[ANSEM-データ投入運用方針]] | 誰がどうデータを入れるかの方針 | 5分 |
| 5 | [[ANSEM-一括登録機能メモ]] | 一括登録の仕様・重複防止アイデア | 5分 |
| 6 | [[ANSEM-追加機能ロードマップ]] | 今後の機能開発Phase 1-4 | 5分 |

### 参考（必要に応じて）

| ファイル | 内容 |
|---------|------|
| [[ANSEM-要件変更ログ]] | 会議での決定事項・当初要件からの変更点 |
| `sql/` フォルダ（5ファイル） | 実行用DDL（エンジニアレビュー向け） |
| [[ANSEM-ER図レビュー]] | これまでのレビュー結果と対応状況 |

---

## チェックリスト

### 1. 全体構成

- [ ] 32テーブルに過不足がないか（足りないテーブル / 不要なテーブル）
- [ ] テーブル間のリレーションが業務フローと合っているか
- [ ] マスタ系（m_）とトランザクション系（t_）の分類が適切か

### 2. 設計方針

- [ ] 命名規則が統一されているか（snake_case、プレフィックス m_ / t_）
- [ ] データ型の選定が適切か（TEXT統一、TIMESTAMPTZ統一）
- [ ] 主キー戦略が一貫しているか（GENERATED ALWAYS AS IDENTITY）
- [ ] 外部キーのON DELETE方針が明確か（RESTRICT / CASCADE / SET NULL）

### 3. 業務要件との整合性

- [ ] インフルエンサー管理の要件を満たしているか
  - [ ] IF基本情報（m_influencers）
  - [ ] SNSアカウント管理（t_influencer_sns_accounts）
  - [ ] 住所・口座・請求先（t_addresses, t_bank_accounts, t_billing_info）
  - [ ] 担当者アサイン（t_influencer_agent_assignments）
- [ ] パートナー・広告管理の要件を満たしているか
  - [ ] パートナーサイト（t_partner_sites）
  - [ ] IF卸 / トータルマーケット区分（m_partners_division）
  - [ ] 広告グループ → コンテンツ → キャンペーンの階層
- [ ] 集計・請求の要件を満たしているか
  - [ ] 日次CV集計（t_daily_performance_details）
  - [ ] 日次クリック集計（t_daily_click_details）
  - [ ] 単価設定（t_unit_prices）— 期間管理・楽観ロック
  - [ ] 請求確定フロー（t_billing_runs + t_billing_line_items）

### 4. データ整合性・安全性

- [ ] 全テーブルに監査カラム（created_by, updated_by, created_at, updated_at）があるか
- [ ] セキュリティ情報が分離されているか（m_agent_security, m_influencer_security）
- [ ] 論理削除の設計が適切か（is_cancelled + CHECK制約）
- [ ] 楽観ロック（version）が必要なテーブルに実装されているか
- [ ] CHECK制約でステータス値が制限されているか

### 5. パフォーマンス

- [ ] インデックスが適切に設定されているか（検索頻度の高いカラム）
- [ ] パーティション戦略が適切か
  - [ ] t_daily_performance_details: 年次パーティション
  - [ ] t_daily_click_details: 年次パーティション
  - [ ] t_audit_logs: 月次パーティション
- [ ] 大量データになりうるテーブルにスケーリング方針があるか

### 6. 運用面

- [ ] データ投入方針（個別登録 / 一括登録）が現実的か
- [ ] 重複防止の仕組みが十分か（DB制約 + アプリバリデーション）
- [ ] 非エンジニアでもデータ投入できるフォーマットが検討されているか
- [ ] 今後の機能開発のフェーズ分けが妥当か（Phase 1-4）

---

## レビュー観点の優先度

```
【最重要】業務要件との整合性
  → テーブルが足りない / 余計なものがあると後から大変

【重要】データ整合性・安全性
  → 制約が甘いとデータ品質が崩壊する

【中】パフォーマンス
  → 後からインデックス追加・パーティション変更は可能

【低】命名規則・コメント
  → 一貫性は大事だが、後から修正しやすい
```

---

## フィードバックの書き方テンプレート

レビュー結果は以下のフォーマットで記載してもらえると反映しやすい:

```markdown
### 指摘事項

#### [重要度: 高/中/低] 指摘タイトル

- **対象**: テーブル名 or セクション名
- **現状**: 今こうなっている
- **提案**: こうした方がいい
- **理由**: なぜそう思うか
```

### フィードバック例

```markdown
#### [重要度: 中] t_unit_prices の期間重複チェック

- **対象**: t_unit_prices
- **現状**: start_at / end_at で期間管理しているが、同一条件で期間が重複した場合のチェックがない
- **提案**: EXCLUDE制約 or アプリ側でバリデーション追加
- **理由**: 単価が二重に適用されるリスクがある
```

---

## 設計のハイライト（レビュアー向け参考）

レビュー時に「なぜこうなっているか」の背景があると判断しやすいため、主要な設計判断をまとめる。

| 設計判断 | 理由 |
|---------|------|
| TEXT統一（VARCHAR禁止） | PostgreSQLではTEXTとVARCHARの性能差なし。長さ制約はアプリ層で |
| セキュリティ分離テーブル | パスワードハッシュ等を通常の参照クエリから隔離 |
| スナップショット方式（請求明細） | 確定時の名称を保存し、マスタ変更の影響を受けない |
| 論理削除（is_cancelled） | 請求確定は物理削除不可。CHECK制約で整合性保証 |
| パーティション | 集計テーブルは年単位、監査ログは月単位で分割しクエリ性能を確保 |
| 楽観ロック（version） | 同時編集時のデータ競合を防止（m_influencers等） |
| ON DELETE RESTRICT原則 | 参照先を安易に削除させない。データ保全が最優先 |

---

_作成: 2026-02-12_
