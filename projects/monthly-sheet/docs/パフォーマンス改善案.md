# 月別シート関数 パフォーマンス改善案

> [!abstract] 方針
> **仕様変更なし・計算結果は同一を維持**したまま、Google Sheetsの処理速度を改善する。

---

## 改善サマリー

| 項目 | 対象セル数 | 期待効果 |
|------|-----------|---------|
| 1. 範囲の閉鎖化 | 14セル | ★★★ 即効性が高い |
| 2. XLOOKUP集約 | 14セル → 2〜3式 | ★★★ 最大のボトルネック解消 |
| 3. LETによる計算キャッシュ | 7セル | ★★☆ 重複計算の排除 |
| 4. CV参照の検索キー事前結合 | 3セル | ★★☆ 文字列結合の削減 |
| 5. 源泉徴収ロジックの簡約化 | 2セル | ★☆☆ 演算回数の削減 |
| 6. SUMPRODUCT→COUNTIF置換 | 1セル | ★☆☆ 軽量関数への切替 |

---

## 改善1: オープンレンジの閉鎖化 ★★★

### 問題

`SUM(S5:S)` のようにオープンレンジ（列全体）を対象にしていると、Google Sheetsは約1,000行以上の空行も走査する。

### 対象セル

S2, T2, Z2, AA2, AH2, AI2, AJ2, AL2, AN2, AP2, BE2, BF2, BO2

### 改善

すべてのSUM範囲をデータ行に限定する（5〜169行 or 170行〜末尾の固定行）。

```
■ Before
=SUM(S5:S)

■ After
=SUM(S5:S169)
```

```
■ Before（170行目始まりのもの）
=SUM(AJ170:AJ)

■ After（末尾行を確定させる。例: 200行目まで）
=SUM(AJ170:AJ200)
```

> [!TIP]
> 170行目以降のセルも末尾行が固定できるなら閉じる。
> 末尾が動的に変わる場合でも、上限行（例: 500行）を設定するだけで改善する。

---

## 改善2: XLOOKUP集約（最大効果） ★★★

### 問題

現状、`マスター原本` への XLOOKUP が **14本の独立した ArrayFormula** で動いている。
すべて同じ検索キー（`E列&BB列` → `マスター原本!B列&R列7桁`）を使っているにもかかわらず、毎回キーの結合・照合を繰り返している。

**これが最大のパフォーマンスボトルネック。**

### 改善案A: 1本のXLOOKUPで複数列を一括取得

XLOOKUPの戻り値を範囲指定し、1回の検索で複数カラムをまとめて返す。

```
■ Before（14本バラバラ）
H5  = ArrayFormula(XLOOKUP(E5:E&BB5:BB, ..., マスター原本!C:C))
AB5 = ArrayFormula(XLOOKUP(E5:E&BB5:BB, ..., マスター原本!I:I))
AC5 = ArrayFormula(XLOOKUP(E5:E&BB5:BB, ..., マスター原本!J:J))
AR5 = ArrayFormula(XLOOKUP(E5:E&BB5:BB, ..., マスター原本!K:K))
  ...（以下14本）

■ After（1本に集約 → ヘルパー行 or 列に展開）
```

**方法: ヘルパーシート方式**

1. 新規シート `_cache` を作成
2. `_cache!A5` に1本だけ ArrayFormula + XLOOKUP を配置し、必要な全列を一括取得:

```
=ArrayFormula(
  IFERROR(
    XLOOKUP(
      月別!E5:E169 & 月別!BB5:BB169,
      マスター原本!B2:B & TEXT(マスター原本!R2:R,"0000000"),
      マスター原本!C2:S2
    )
  )
)
```

3. 月別シートの各セル（H5, AB5, AC5...）は `_cache` シートを単純参照するだけにする:

```
H5  = _cache!A5:A169   （C列に相当）
AB5 = _cache!G5:G169   （I列に相当）
AC5 = _cache!H5:H169   （J列に相当）
...
```

> [!IMPORTANT]
> **効果: XLOOKUP の検索キー結合+照合が14回 → 1回になる。**
> データ165行 × XLOOKUP14本 = 2,310回の照合 → 165回に削減。

### 改善案B: ヘルパーシートを使わない場合

LET で検索キーをキャッシュし、2〜3グループに分割する。

```
■ H5（マスター原本 C〜J列グループ）
=ArrayFormula(
  LET(
    key, E5:E169 & BB5:BB169,
    master_key, マスター原本!B2:B & TEXT(マスター原本!R2:R,"0000000"),
    XLOOKUP(key, master_key, マスター原本!C2:J2)
  )
)
```

これで H5 に C〜J列（8列分）が横に展開される。
AB5, AC5 などは `=H5` からのオフセット参照、または CHOOSECOLS で個別列を取り出す:

```
AB5 = ArrayFormula(CHOOSECOLS(H5:O169, 7))  （I列 = 7番目）
AC5 = ArrayFormula(CHOOSECOLS(H5:O169, 8))  （J列 = 8番目）
```

残りの K〜S列グループも同様に1本にまとめる。

---

## 改善3: 売上・利益計算のLETキャッシュ化 ★★☆

### 問題

S5, T5, Z5, AA5 などで同じ列の参照・条件判定を個別に繰り返している。

### 改善

```
■ Before: S5（売上）
=ArrayFormula(IF(D5:D="予算/ボーナス", N5:N, R5:R * N5:N))

■ Before: T5（利益）
=ArrayFormula(IF(BG5:BG="成果", S5:S - (R5:R * AF5:AF), S5:S - BF5:BF))
```

```
■ After: T5（利益）をLETで最適化
=ArrayFormula(
  LET(
    s, S5:S169,
    r, R5:R169,
    af, AF5:AF169,
    bf, BF5:BF169,
    bg, BG5:BG169,
    IF(bg="成果", s - (r * af), s - bf)
  )
)
```

同様に Z5, AA5 もLETで共通参照をまとめる:

```
■ After: Z5（確定売上）
=ArrayFormula(
  LET(
    q, Q5:Q169,
    d, D5:D169,
    n, N5:N169,
    x, X5:X169,
    IF(q=TRUE,
      IF(d="予算/ボーナス", n, n * x),
      0
    )
  )
)

■ After: AA5（確定利益）
=ArrayFormula(
  LET(
    q, Q5:Q169,
    z, Z5:Z169,
    bf, BF5:BF169,
    IF(q=TRUE, z - bf, z)
  )
)
```

---

## 改善4: CV参照の検索キー事前計算 ★★☆

### 問題

U5, V5, W5 の3セルが、それぞれ独立に5つの値を文字列結合して検索キーを生成している。
さらに内部で `◆list` への XLOOKUP も毎回実行。

### 改善

検索キーの生成を1回だけにしてLETで共有する。

**方法: 補助列を1本追加する**

例えば BQ列（空き列）に検索キーを事前計算:

```
BQ5 =ArrayFormula(
  LET(
    ym, TEXT(B2,"YYMM"),
    agent, XLOOKUP(MID(B5:B169,5,10), '◆list'!F:F, '◆list'!E:E),
    ym & M5:M169 & L5:L169 & agent & F5:F169
  )
)
```

U5, V5, W5 はキーを参照するだけにする:

```
■ After: U5
=ArrayFormula(
  IFERROR(XLOOKUP(BQ5:BQ169, '◆CV'!キー列, '◆CV'!F:F))
)

■ After: V5
=ArrayFormula(
  IFERROR(XLOOKUP(BQ5:BQ169, '◆CV'!キー列, '◆CV'!G:G))
)

■ After: W5
=ArrayFormula(
  LET(
    cv_h, IFERROR(XLOOKUP(BQ5:BQ169, '◆CV'!キー列, '◆CV'!H:H)),
    x, X5:X169,
    IF(x<>"", x, cv_h)
  )
)
```

> [!TIP]
> ◆list への XLOOKUP も3回→1回に削減。
> 文字列結合（5要素 × 165行）が3回→1回に削減。

---

## 改善5: 源泉徴収の計算簡約化 ★☆☆

### 問題

AE5, AG5 で同じ税計算ロジックを冗長に記述:
```
ROUNDUP((金額/1.1) + (金額 - 金額/1.1) - (金額 - 金額/1.1)*0.2)
```

展開すると: `金額/1.1 + 金額×0.1/1.1 - 金額×0.1/1.1×0.2`

### 改善

数学的に簡約化（結果は同一）:

```
元の式を展開:
= 金額/1.1 + (金額 - 金額/1.1) × 0.8
= 金額/1.1 + 金額 × (1 - 1/1.1) × 0.8
= 金額/1.1 + 金額 × (0.1/1.1) × 0.8
= 金額 × (1/1.1 + 0.08/1.1)
= 金額 × 1.08/1.1
```

```
■ Before: AE5
=ArrayFormula(ROUNDUP((AD5:AD/1.1)+(AD5:AD-AD5:AD/1.1)-(AD5:AD-AD5:AD/1.1)*0.2))

■ After: AE5
=ArrayFormula(ROUNDUP(AD5:AD169 * 1.08/1.1))

■ After: AG5
=ArrayFormula(ROUNDUP(AF5:AF169 * 1.08/1.1))
```

> [!NOTE]
> 演算回数: 1行あたり 7回 → 2回（÷約3.5倍）。
> ROUNDUP の切り上げ挙動が同一であることを**必ず数件テストしてから適用**すること。

---

## 改善6: N2のエラーカウント軽量化 ★☆☆

### 問題

```
=SUMPRODUCT(ISERROR(B3:BD3)*1) + SUMPRODUCT(ISERROR(B5:BD)*1)
```

SUMPRODUCT + ISERROR は全セルに対して配列演算を行うため重い。
特に `B5:BD` がオープンレンジ。

### 改善

```
■ After
=SUMPRODUCT(ISERROR(B3:BD3)*1) + SUMPRODUCT(ISERROR(B5:BD169)*1)
```

最低限、範囲を閉じる。

さらに可能なら、エラーが発生しうる列のみに限定:

```
■ さらに最適化（エラーが出る列が特定できる場合）
=SUMPRODUCT(ISERROR(B3:BD3)*1)
 + SUMPRODUCT(ISERROR(H5:I169)*1)
 + SUMPRODUCT(ISERROR(U5:W169)*1)
 + SUMPRODUCT(ISERROR(AB5:AC169)*1)
```

> [!TIP]
> XLOOKUP系の列だけがエラーを返す可能性が高い。
> 対象列を絞れば走査セル数が `56列×165行=9,240セル` → 数百セルに激減する。

---

## 適用の優先順位

```
推奨順:
1️⃣  改善1（範囲閉鎖）     → リスクゼロ。今すぐ全セルに適用
2️⃣  改善2A（XLOOKUP集約）  → 最大効果。ヘルパーシート導入で劇的改善
3️⃣  改善4（CV検索キー集約） → 補助列1本追加で3セル改善
4️⃣  改善3（LETキャッシュ）  → 各セル個別に適用可能
5️⃣  改善5（源泉簡約）      → テスト必須だが効果あり
6️⃣  改善6（エラーカウント）  → 範囲閉鎖だけでも効果あり
```

> [!WARNING]
> **適用前チェックリスト:**
> - [ ] 改善前のシートをコピーしてバックアップを取る
> - [ ] 各改善を1つずつ適用し、Before/After で計算結果が一致することを確認
> - [ ] 特に改善5（源泉）は端数処理で差異が出る可能性があるため、全行で検算
> - [ ] 改善2でヘルパーシートを使う場合、シート保護・非表示を設定

---

---

# コピペ用関数一覧

> [!ABSTRACT] 使い方
> 各Stepのコードをそのままセルに貼り付ける。
> `_cache` シートは新規作成が必要（Step 2）。
> `BQ列` は空き列である前提（Step 3）。

---

## Step 1: オープンレンジ閉鎖（SUM関数 13セル）

> [!NOTE]
> BO2 は既に `SUM(BO5:BO169)` で閉鎖済みのため変更不要。
> 5〜169行: データ行、170〜200行: 集計セクション（末尾行は実際のデータに合わせて調整）。

| セル | Before | After |
|------|--------|-------|
| S2 | `=SUM(S5:S)` | `=SUM(S5:S169)` |
| T2 | `=SUM(T5:T)` | `=SUM(T5:T169)` |
| Z2 | `=SUM(Z5:Z)` | `=SUM(Z5:Z169)` |
| AA2 | `=SUM(AA5:AA)` | `=SUM(AA5:AA169)` |
| AH2 | `=SUM(AH5:AH)` | `=SUM(AH5:AH169)` |
| AI2 | `=SUM(AI5:AI)` | `=SUM(AI5:AI169)` |
| AJ2 | `=SUM(AJ170:AJ)` | `=SUM(AJ170:AJ200)` |
| AL2 | `=SUM(AL170:AL)` | `=SUM(AL170:AL200)` |
| AN2 | `=SUM(AN170:AN)` | `=SUM(AN170:AN200)` |
| AP2 | `=SUM(AP170:AP)` | `=SUM(AP170:AP200)` |
| BE2 | `=SUM(BE170:BE)` | `=SUM(BE170:BE200)` |
| BF2 | `=SUM(BF170:BF)` | `=SUM(BF170:BF200)` |
| BO2 | `=SUM(BO5:BO169)` | 変更不要（閉鎖済み） |

---

## Step 2: XLOOKUP集約（_cache シート方式）

### 2-1. _cache シートの作成

新規シート `_cache` を作成し、**A5セル**に以下の1本だけ配置する:

```
=ArrayFormula(
  IFERROR(
    XLOOKUP(
      '2026年02月'!E5:E169 & '2026年02月'!BB5:BB169,
      マスター原本!B2:B & TEXT(マスター原本!R2:R,"0000000"),
      マスター原本!C2:S2
    )
  )
)
```

> [!TIP]
> この1式で `_cache!A5:Q169`（165行 × 17列）にマスター原本のC〜S列が展開される。

### 2-2. _cache 列マッピング

| _cache列 | マスター原本列 | 参照元（月別シート） | 用途 |
|----------|-------------|-------------------|------|
| A | C列 | H5 | IF名称 |
| B | D列 | I5（条件分岐用） | Instagram |
| C | E列 | I5（条件分岐用） | YouTube |
| D | F列 | I5（条件分岐用） | Twitter |
| E | G列 | I5（条件分岐用） | TikTok |
| F | H列 | I5（条件分岐用） | その他/デフォルト |
| G | I列 | AB5 | 支払区分 |
| H | J列 | AC5 | 支払関連 |
| I | K列 | AR5 | — |
| J | L列 | AT5 | — |
| K | M列 | AW5 | — |
| L | N列 | AX5 | — |
| M | O列 | AY5 | 金融機関名 |
| N | P列 | AZ5 | 支店名 |
| O | Q列 | BA5 | 口座種別 |
| P | R列 | （検索キー用・直接参照なし） | — |
| Q | S列 | BC5 | 口座番号 |

### 2-3. 月別シート側の参照式（11セル）

各セルの既存 ArrayFormula(XLOOKUP(...)) を以下に置換する:

```
H5  = ArrayFormula(_cache!A5:A169)
AB5 = ArrayFormula(_cache!G5:G169)
AC5 = ArrayFormula(_cache!H5:H169)
AR5 = ArrayFormula(_cache!I5:I169)
AT5 = ArrayFormula(_cache!J5:J169)
AW5 = ArrayFormula(_cache!K5:K169)
AX5 = ArrayFormula(_cache!L5:L169)
AY5 = ArrayFormula(_cache!M5:M169)
AZ5 = ArrayFormula(_cache!N5:N169)
BA5 = ArrayFormula(_cache!O5:O169)
BC5 = ArrayFormula(_cache!Q5:Q169)
```

> [!WARNING]
> **BN5** はマスター原本の参照先列が未確認。
> 実際のシートで BN5 の XLOOKUP が参照している列を確認し、上記マッピング表から対応する _cache 列を特定してから置換すること。

### 2-4. I5: SNS分岐（LET最適化版）

I5 は G列の値に応じてマスター原本の異なる列（D〜H）を参照する特殊セル。
_cache の B〜F列（= マスター原本 D〜H列）を条件分岐で選択する:

```
=ArrayFormula(
  LET(
    g, G5:G169,
    ig,     _cache!B5:B169,
    yt,     _cache!C5:C169,
    tw,     _cache!D5:D169,
    tiktok, _cache!E5:E169,
    other,  _cache!F5:F169,
    IFS(
      (g="")+(g=0),                      ig,
      g=2,                               other,
      REGEXMATCH(LOWER(g),"instagram"),  ig,
      REGEXMATCH(LOWER(g),"youtube"),    yt,
      REGEXMATCH(LOWER(g),"twitter"),    tw,
      REGEXMATCH(LOWER(g),"tiktok"),     tiktok,
      TRUE,                              other
    )
  )
)
```

> [!NOTE]
> _cache 参照のため XLOOKUP が完全に不要になる。
> 条件分岐のみ（文字列比較）でSNSアカウントを取得。

---

## Step 3: CV検索キー集約（BQ5 + U5, V5, W5）

### 3-1. BQ5: 検索キー生成式（空き列に配置）

```
=ArrayFormula(
  LET(
    ym, TEXT(B2,"YYMM"),
    agent, XLOOKUP(MID(B5:B169,5,10), '◆list'!F:F, '◆list'!E:E),
    ym & M5:M169 & L5:L169 & agent & F5:F169
  )
)
```

### 3-2. U5: CV参照（簡略版）

```
=ArrayFormula(
  IFERROR(XLOOKUP(BQ5:BQ169, '◆CV'!キー列, '◆CV'!F:F))
)
```

### 3-3. V5: CV参照（簡略版）

```
=ArrayFormula(
  IFERROR(XLOOKUP(BQ5:BQ169, '◆CV'!キー列, '◆CV'!G:G))
)
```

### 3-4. W5: CV参照 + 手動上書き対応

```
=ArrayFormula(
  LET(
    cv_h, IFERROR(XLOOKUP(BQ5:BQ169, '◆CV'!キー列, '◆CV'!H:H)),
    x, X5:X169,
    IF(x<>"", x, cv_h)
  )
)
```

> [!TIP]
> `キー列` は ◆CV シートの実際のキー列（A列等）に置き換えること。
> ◆list への XLOOKUP も3回→1回、文字列結合も3回→1回に削減。

---

## Step 4: LETキャッシュ化（T5, Z5, AA5）

### 4-1. T5: 利益計算

```
=ArrayFormula(
  LET(
    s, S5:S169,
    r, R5:R169,
    af, AF5:AF169,
    bf, BF5:BF169,
    bg, BG5:BG169,
    IF(bg="成果", s - (r * af), s - bf)
  )
)
```

### 4-2. Z5: 確定売上

```
=ArrayFormula(
  LET(
    q, Q5:Q169,
    d, D5:D169,
    n, N5:N169,
    x, X5:X169,
    IF(q=TRUE,
      IF(d="予算/ボーナス", n, n * x),
      0
    )
  )
)
```

### 4-3. AA5: 確定利益

```
=ArrayFormula(
  LET(
    q, Q5:Q169,
    z, Z5:Z169,
    bf, BF5:BF169,
    IF(q=TRUE, z - bf, z)
  )
)
```

---

## Step 5: 源泉徴収簡約化（AE5, AG5）

### 5-1. AE5: 源泉徴収（固定費）

```
■ Before
=ArrayFormula(ROUNDUP((AD5:AD/1.1)+(AD5:AD-AD5:AD/1.1)-(AD5:AD-AD5:AD/1.1)*0.2))

■ After
=ArrayFormula(ROUNDUP(AD5:AD169 * 1.08/1.1))
```

### 5-2. AG5: 源泉徴収（成果報酬費）

```
■ Before
=ArrayFormula(ROUNDUP((AF5:AF/1.1)+(AF5:AF-AF5:AF/1.1)-(AF5:AF-AF5:AF/1.1)*0.2))

■ After
=ArrayFormula(ROUNDUP(AF5:AF169 * 1.08/1.1))
```

> [!CAUTION]
> 数学的には同値（`金額/1.1 + 金額×0.08/1.1 = 金額×1.08/1.1`）だが、
> ROUNDUP の端数処理で **1件でも差異が出た場合は即スキップ**すること。
> 適用前に全165行で Before/After の一致を確認する。

---

## Step 6: エラーカウント範囲限定（N2）

### 6-1. N2: 最低限の閉鎖版

```
=SUMPRODUCT(ISERROR(B3:BD3)*1) + SUMPRODUCT(ISERROR(B5:BD169)*1)
```

### 6-2. N2: さらに最適化版（エラー発生列のみ走査）

```
=SUMPRODUCT(ISERROR(B3:BD3)*1)
 + SUMPRODUCT(ISERROR(H5:I169)*1)
 + SUMPRODUCT(ISERROR(U5:W169)*1)
 + SUMPRODUCT(ISERROR(AB5:AC169)*1)
```

> [!NOTE]
> 6-2 は XLOOKUP 系の列（エラーを返す可能性がある列）のみに絞った版。
> 走査セル数: 56列×165行 = 9,240セル → 8列×165行 = 1,320セルに削減。
> 他にエラーが出る列がある場合は追加すること。

---

# 実行手順書

> [!ABSTRACT] 概要
> 改善を安全にシートへ適用するための手順。
> 各Stepごとに検証を行い、不一致があればそのStepだけロールバックする。

---

## フェーズ1: バックアップと検証環境の準備

### 1-1. バックアップ作成

1. 月別シート（2026年02月）をシートごとコピー → `月別_backup_0217` として保存
2. 作業用にもう1枚コピー → `月別_作業用` を作成（ここで改善を適用）

### 1-2. 検算用の基準値メモ

以下のセルの現在値を記録しておく（改善後の照合に使用）:

| セル | 用途 | 現在値（メモ欄） |
|------|------|----------------|
| S2 | 売上合計 | |
| T2 | 利益合計 | |
| Z2 | 確定売上合計 | |
| AA2 | 確定利益合計 | |
| AH2 | IF報酬合計 | |
| AI2 | 差引合計 | |
| BE2 | 確定CV合計 | |
| BF2 | 手数料合計 | |
| BO2 | 差額合計 | |
| N2 | エラーセル数 | |

---

## フェーズ2: 改善適用（Step 1〜6を順番に）

### 適用サマリー

| Step | 内容 | 対象セル数 | リスク | 所要時間目安 |
|------|------|-----------|-------|------------|
| 1 | オープンレンジ閉鎖 | 13 | 低 | 短 |
| 2 | XLOOKUP集約（_cacheシート） | 12+1特殊 | 中 | 中 |
| 3 | CV検索キー集約 | 4（BQ5+3セル） | 低 | 短 |
| 4 | LETキャッシュ化 | 3 | 低 | 短 |
| 5 | 源泉徴収簡約 | 2 | ⚠️ 要検算 | 中 |
| 6 | エラーカウント範囲限定 | 1 | 低 | 短 |

### 各Stepの適用手順

#### Step 1: オープンレンジ閉鎖

1. 上記「Step 1」の13セルを順番に Before → After に書き換え
2. **検証:** S2, T2, Z2, AA2, AH2, AI2 の値が基準値と一致するか確認
3. 170行目以降のセル（AJ2, AL2, AN2, AP2, BE2, BF2）も値が一致するか確認
4. 不一致 → Ctrl+Z で戻す

#### Step 2: XLOOKUP集約

1. 新規シート `_cache` を作成
2. `_cache!A5` に「2-1」の式を貼り付け → 展開を確認
3. 月別シートの各セル（H5, AB5, AC5 等）を「2-3」の参照式に置換
4. I5 を「2-4」の LET 版に置換
5. **検証:** H列、AB列、AC列 等の値がバックアップと一致するか確認（ランダム10行）
6. 不一致 → _cache シート削除 + 月別セルを Ctrl+Z で戻す
7. 問題なければ `_cache` シートを **非表示 + シート保護** に設定

> [!IMPORTANT]
> BN5 は参照先列が未確認のため、_cache マッピングを特定してから個別に置換すること。

#### Step 3: CV検索キー集約

1. BQ5 に「3-1」の検索キー生成式を貼り付け
2. U5, V5, W5 を「3-2」「3-3」「3-4」に置換
3. **検証:** U列、V列、W列の値がバックアップと一致するか確認
4. 不一致 → BQ列クリア + U5, V5, W5 を Ctrl+Z

#### Step 4: LETキャッシュ化

1. T5 を「4-1」に置換
2. Z5 を「4-2」に置換
3. AA5 を「4-3」に置換
4. **検証:** T2, Z2, AA2 の合計値 + ランダム5行の個別値を確認
5. 不一致 → 該当セルだけ Ctrl+Z

#### Step 5: 源泉徴収簡約

1. AE5 を「5-1」の After に置換
2. **検証:** AE列の全165行で Before/After の値を突合
3. **1件でも不一致 → 即 Ctrl+Z でスキップ**
4. AE5 が OK なら AG5 も「5-2」に置換 → 同様に全行検算

#### Step 6: エラーカウント

1. N2 を「6-1」（最低限の閉鎖版）に置換
2. **検証:** N2 の値が基準値と一致するか確認
3. OK なら、さらに「6-2」（最適化版）に差し替えても良い
4. 不一致 → Ctrl+Z

---

## フェーズ3: 最終検証

### 3-1. 合計値の完全一致確認

| セル | backup値 | 作業用値 | 一致 |
|------|---------|---------|------|
| S2 | | | ☐ |
| T2 | | | ☐ |
| Z2 | | | ☐ |
| AA2 | | | ☐ |
| AH2 | | | ☐ |
| AI2 | | | ☐ |
| BE2 | | | ☐ |
| BF2 | | | ☐ |
| BO2 | | | ☐ |
| N2 | | | ☐ |

### 3-2. ランダム行の突合

任意の10行を選び、以下の列の値をバックアップと比較:
- H列, I列（マスター参照）
- S列, T列（売上・利益）
- U列, V列, W列（CV参照）
- Z列, AA列（確定売上・利益）
- AE列, AG列（源泉徴収）※ Step 5 適用時のみ

### 3-3. 本番昇格

1. すべて一致を確認したら `月別_作業用` を本番シート名（`2026年02月`）にリネーム
2. 元のシートは `月別_旧_0217` にリネームして退避
3. `_cache` シートが非表示+保護されていることを再確認

---

## フェーズ4: ドキュメント更新・後処理

### 4-1. 適用結果の記録

| Step | 結果 | 備考 |
|------|------|------|
| 1 範囲閉鎖 | 適用済み / スキップ | |
| 2 XLOOKUP集約 | 適用済み / スキップ | |
| 3 CV検索キー | 適用済み / スキップ | |
| 4 LETキャッシュ | 適用済み / スキップ | |
| 5 源泉簡約 | 適用済み / スキップ | |
| 6 エラーカウント | 適用済み / スキップ | |

### 4-2. 後処理チェックリスト

- [ ] `_cache` シートが非表示+保護になっている
- [ ] バックアップシート（`月別_backup_0217`）を保持
- [ ] チームに改善完了を共有
- [ ] 旧シート（`月別_旧_0217`）は1週間後に問題なければ削除

---

## リスク管理

| リスク | 対策 |
|-------|------|
| 計算結果の不一致 | 各Stepごとに検証。不一致 → そのStepだけロールバック |
| ヘルパーシート追加による混乱 | `_cache` は非表示+シート保護を設定 |
| 源泉徴収の端数差異 | Step 5 は1件でも不一致 → 即スキップ |
| 他メンバーの同時編集 | 作業中はチームに共有。本番反映は編集がない時間帯に |
| BN5 の参照先不明 | 実シートで確認後に個別対応。未確認のまま変更しない |

---

_最終更新: 2026-02-17_
